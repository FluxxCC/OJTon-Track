<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Instructor — Choose Section</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container centered">
      <div class="dashboard-main center-page">
        <h2 class="welcome">Choose Section</h2>
        <p class="subtitle accent">Select the section you handle</p>
        <div id="contentBox" class="buttons" style="width:min(92vw,560px);margin:0 auto"></div>
        <div class="buttons" style="width:min(92vw,560px);margin-top:1rem;display:grid;grid-template-columns:1fr;gap:8px">
          <button id="addStudentBtn" class="role-button">Add Student</button>
          <a class="role-button" href="/instructor/dashboard.html">Back</a>
        </div>
      </div>
    </main>
    <nav class="student-nav">
      <div class="student-nav-inner">
        <a href="/instructor/dashboard.html" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5l9-7 9 7"/><path d="M5 11v9h14v-9"/></svg>
        </a>
        <a href="/instructor/students.html" aria-label="Logs">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </a>
        <a href="/instructor/reports.html" aria-label="Reports">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V5a2 2 0 012-2h10"/><path d="M20 7v12a2 2 0 01-2 2H6"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>
        </a>
        <a href="/instructor/profile.html" aria-label="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </a>
      </div>
    </nav>
    <script>
      function authHeaders(json){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
      async function hookSupervisorOptions(){ try { const modal=document.getElementById('instructorAddModal'); if(!modal) return; const courseSel=modal.querySelector('select[name="course"]'); const sectionSel=modal.querySelector('select[name="section"]'); let supHidden=modal.querySelector('input[name="supervisorId"]'); let supBtn=Array.from(modal.querySelectorAll('button.input')).find(b=>String(b.textContent||'').startsWith('Assign Supervisor')); const supSel=modal.querySelector('select[name="supervisorId"]'); if(!courseSel||!sectionSel) return; if (!supHidden) { supHidden=document.createElement('input'); supHidden.type='text'; supHidden.name='supervisorId'; supHidden.style.display='none'; const form=modal.querySelector('form'); if(form) form.insertBefore(supHidden, supSel || null); }
        if (!supBtn) { supBtn=document.createElement('button'); supBtn.type='button'; supBtn.className='input'; supBtn.textContent='Assign Supervisor'; supBtn.style.width='94%'; supBtn.style.margin='0 auto'; supBtn.style.textAlign='center'; const form=modal.querySelector('form'); if(form) form.insertBefore(supBtn, supSel || null); }
        if (supSel) supSel.style.display='none';
        async function openList(){ const c=String(courseSel.value||'').trim().toUpperCase(); const s=String(sectionSel.value||'').trim().toUpperCase(); if(!c || !s) return; let arr=[]; try { const u1='/api/supervisors?course='+encodeURIComponent(c)+'&section='+encodeURIComponent(s); const r=await fetch(u1, { headers: authHeaders() }); const j=await r.json().catch(()=>({})); arr=(r.ok && j && j.ok && Array.isArray(j.data)) ? j.data : []; if(!arr.length){ const u2='/api/supervisors?section='+encodeURIComponent(s); const r2=await fetch(u2, { headers: authHeaders() }); const j2=await r2.json().catch(()=>({})); let arr2=(r2.ok && j2 && j2.ok && Array.isArray(j2.data)) ? j2.data : []; arr=arr2.filter(row=>String(row.course||'').trim().toUpperCase()===c); }
        if(!arr.length){ const r3=await fetch('/api/supervisors', { headers: authHeaders() }); const j3=await r3.json().catch(()=>({})); let arr3=(r3.ok && j3 && j3.ok && Array.isArray(j3.data)) ? j3.data : []; arr=arr3.filter(row=>String(row.section||'').trim().toUpperCase()===s && String(row.course||'').trim().toUpperCase()===c); } } catch { arr=[]; }
        const overlay=document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(2,6,23,0.5)'; overlay.style.display='grid'; overlay.style.placeItems='center'; overlay.style.zIndex='1001'; overlay.style.padding='1rem'; overlay.addEventListener('click',function(e){ if(e.target===overlay) overlay.remove(); }); const box=document.createElement('div'); box.style.background='#fff'; box.style.color='#000'; box.style.padding='16px'; box.style.borderRadius='12px'; box.style.width='clamp(280px,80vw,520px)'; box.style.maxHeight='70vh'; box.style.overflowY='auto'; box.style.display='grid'; box.style.gap='8px'; const head=document.createElement('div'); head.style.fontWeight='800'; head.style.textAlign='center'; head.textContent='Assign Supervisor'; const close=document.createElement('button'); close.type='button'; close.textContent='×'; close.style.position='absolute'; close.style.top='8px'; close.style.right='8px'; close.style.padding='2px 8px'; close.style.fontSize='18px'; close.style.lineHeight='1'; close.style.border='none'; close.style.background='transparent'; close.style.cursor='pointer'; const wrap=document.createElement('div'); wrap.style.position='relative'; wrap.appendChild(close); wrap.appendChild(head); const list=document.createElement('div'); list.style.display='grid'; list.style.gap='8px'; arr.forEach(row=>{ const id=String(row.idNumber||row.idnumber||'').trim(); if(!id) return; const nm=String(row.name||'').trim(); const btn=document.createElement('button'); btn.type='button'; btn.className='role-button'; btn.style.width='100%'; btn.style.textAlign='center'; btn.textContent=(nm? (id+' — '+nm) : id); btn.addEventListener('click', function(){ supHidden.value=id; supBtn.textContent = (nm? (id+' — '+nm) : id); overlay.remove(); }); list.appendChild(btn); }); if(!list.childNodes.length){ const none=document.createElement('div'); none.style.textAlign='center'; none.textContent='No supervisors for selected course/section'; list.appendChild(none); } close.addEventListener('click', function(){ overlay.remove(); }); box.appendChild(wrap); box.appendChild(list); document.body.appendChild(overlay); overlay.appendChild(box); }
        supBtn.addEventListener('click', openSupListModal);
        async function openSupListModal(){ let c=String(courseSel.value||'').trim().toUpperCase(); let s=String(sectionSel.value||'').trim().toUpperCase(); if(!c){ const firstC = Array.from(courseSel.options||[]).find(function(o){ return String(o.value||'').trim().length>0; }); if(firstC){ courseSel.value = firstC.value; c = String(firstC.value||'').trim().toUpperCase(); } } if(!s){ const firstS = Array.from(sectionSel.options||[]).find(function(o){ return String(o.value||'').trim().length>0; }); if(firstS){ sectionSel.value = firstS.value; s = String(firstS.value||'').trim().toUpperCase(); } } let arr=[]; if (c && s) { try { const u1='/api/supervisors?course='+encodeURIComponent(c)+'&section='+encodeURIComponent(s); const r=await fetch(u1, { headers: authHeaders() }); const j=await r.json().catch(()=>({})); arr=(r.ok && j && j.ok && Array.isArray(j.data)) ? j.data : []; if(!arr.length){ const u2='/api/supervisors?section='+encodeURIComponent(s); const r2=await fetch(u2, { headers: authHeaders() }); const j2=await r2.json().catch(()=>({})); let arr2=(r2.ok && j2 && j2.ok && Array.isArray(j2.data)) ? j2.data : []; arr=arr2.filter(row=>String(row.course||'').trim().toUpperCase()===c); } if(!arr.length){ const r3=await fetch('/api/supervisors', { headers: authHeaders() }); const j3=await r3.json().catch(()=>({})); let arr3=(r3.ok && j3 && j3.ok && Array.isArray(j3.data)) ? j3.data : []; arr=arr3.filter(row=>String(row.section||'').trim().toUpperCase()===s && String(row.course||'').trim().toUpperCase()===c); } } catch { arr=[]; } }
          const overlay=document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(2,6,23,0.5)'; overlay.style.display='grid'; overlay.style.placeItems='center'; overlay.style.zIndex='1001'; overlay.style.padding='1rem'; overlay.addEventListener('click',function(e){ if(e.target===overlay) overlay.remove(); }); const box=document.createElement('div'); box.style.background='#fff'; box.style.color='#000'; box.style.padding='16px'; box.style.borderRadius='12px'; box.style.width='clamp(280px,80vw,520px)'; box.style.maxHeight='70vh'; box.style.overflowY='auto'; box.style.display='grid'; box.style.gap='8px'; const head=document.createElement('div'); head.style.fontWeight='800'; head.style.textAlign='center'; head.textContent='Assign Supervisor'; const close=document.createElement('button'); close.type='button'; close.textContent='×'; close.style.position='absolute'; close.style.top='8px'; close.style.right='8px'; close.style.padding='2px 8px'; close.style.fontSize='18px'; close.style.lineHeight='1'; close.style.border='none'; close.style.background='transparent'; close.style.cursor='pointer'; const wrap=document.createElement('div'); wrap.style.position='relative'; wrap.appendChild(close); wrap.appendChild(head); const list=document.createElement('div'); list.style.display='grid'; list.style.gap='8px'; arr.forEach(row=>{ const id=String(row.idNumber||row.idnumber||'').trim(); if(!id) return; const nm=String(row.name||'').trim(); const btn=document.createElement('button'); btn.type='button'; btn.className='role-button'; btn.style.width='100%'; btn.style.textAlign='center'; btn.textContent=(nm? (id+' — '+nm) : id); btn.addEventListener('click', function(){ supHidden.value=id; supBtn.textContent = (nm? (id+' — '+nm) : id); overlay.remove(); }); list.appendChild(btn); }); if(!list.childNodes.length){ const none=document.createElement('div'); none.style.textAlign='center'; none.textContent = (!c || !s) ? 'Select course and section first' : 'No supervisors for selected course/section'; list.appendChild(none); } close.addEventListener('click', function(){ overlay.remove(); }); box.appendChild(wrap); box.appendChild(list); document.body.appendChild(overlay); overlay.appendChild(box); }
        courseSel.addEventListener('change', function(){ supHidden.value=''; supBtn.textContent='Assign Supervisor'; });
        sectionSel.addEventListener('change', function(){ supHidden.value=''; supBtn.textContent='Assign Supervisor'; });
      } catch {} }
      function openAddModal(assignments){ try { const existing=document.getElementById('instructorAddModal'); if(existing) existing.remove(); const overlay=document.createElement('div'); overlay.id='instructorAddModal'; overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(2,6,23,0.5)'; overlay.style.backdropFilter='blur(4px)'; overlay.style.display='grid'; overlay.style.placeItems='center'; overlay.style.zIndex='1000'; overlay.style.padding='1rem'; overlay.addEventListener('click',function(e){ if(e.target===overlay) overlay.remove(); }); const box=document.createElement('div'); box.style.width='min(92vw,560px)'; box.style.maxHeight='80vh'; box.style.overflowY='auto'; box.style.background='var(--surface-alpha)'; box.style.borderRadius='12px'; box.style.boxShadow='0 10px 30px rgba(0,0,0,0.25)'; box.style.padding='1rem'; box.style.position='relative'; box.addEventListener('click',function(e){ e.stopPropagation(); }); const close=document.createElement('button'); close.type='button'; close.textContent='×'; close.style.position='absolute'; close.style.top='8px'; close.style.right='8px'; close.style.padding='2px 8px'; close.style.fontSize='18px'; close.style.lineHeight='1'; close.style.border='none'; close.style.background='transparent'; close.style.cursor='pointer'; close.addEventListener('click',function(){ overlay.remove(); }); const title=document.createElement('div'); title.style.fontWeight='700'; title.style.textAlign='center'; title.style.marginBottom='0.5rem'; title.textContent='Add Student'; const form=document.createElement('form'); form.className='form'; form.style.display='grid'; form.style.gap='0.75rem'; form.style.justifyItems='center'; form.style.textAlign='center'; form.style.marginTop='0'; form.style.width='100%'; const input=function(name,placeholder,required){ const el=document.createElement('input'); el.className='input'; el.name=name; el.placeholder=placeholder; if(required) el.required=true; el.style.width='94%'; el.style.margin='0 auto'; el.style.textAlign='center'; return el; }; form.appendChild(input('idNumber','ID Number',true)); form.appendChild(input('password','Password',true)); form.appendChild(input('firstName','First Name',true)); form.appendChild(input('middleName','Middle Name',false)); form.appendChild(input('lastName','Last Name',true)); const courses=Array.from(new Set((assignments||[]).map(a=>String((a.course||a.courseCode||'').toUpperCase()).trim()).filter(Boolean))); const sections=Array.from(new Set((assignments||[]).map(a=>String((a.section||a.sectionCode||'').toUpperCase()).trim()).filter(Boolean))); const courseSel=document.createElement('select'); courseSel.className='input'; courseSel.name='course'; courseSel.required=true; courseSel.style.width='94%'; courseSel.style.margin='0 auto'; courseSel.style.textAlign='center'; courseSel.style.textAlignLast='center'; const ph1=document.createElement('option'); ph1.value=''; ph1.textContent='Assign Course'; courseSel.appendChild(ph1); courses.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; courseSel.appendChild(o); }); const sectionSel=document.createElement('select'); sectionSel.className='input'; sectionSel.name='section'; sectionSel.required=true; sectionSel.style.width='94%'; sectionSel.style.margin='0 auto'; sectionSel.style.textAlign='center'; sectionSel.style.textAlignLast='center'; const ph2=document.createElement('option'); ph2.value=''; ph2.textContent='Assign Section'; sectionSel.appendChild(ph2); sections.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sectionSel.appendChild(o); }); const supSel=document.createElement('select'); supSel.className='input'; supSel.name='supervisorId'; supSel.style.width='94%'; supSel.style.margin='0 auto'; supSel.style.textAlign='center'; supSel.style.textAlignLast='center'; const phSup=document.createElement('option'); phSup.value=''; phSup.textContent='Assign Supervisor'; supSel.appendChild(phSup); async function updateSupOptions(){ const c=String(courseSel.value||'').trim(); const s=String(sectionSel.value||'').trim(); while(supSel.firstChild) supSel.removeChild(supSel.firstChild); const ph=document.createElement('option'); ph.value=''; ph.textContent='Assign Supervisor'; supSel.appendChild(ph); if(!c || !s) return; try { const url='/api/supervisors?course='+encodeURIComponent(c)+'&section='+encodeURIComponent(s); const r=await fetch(url, { headers: authHeaders() }); const j=await r.json().catch(()=>({})); const arr=(r.ok && j && j.ok && Array.isArray(j.data)) ? j.data : []; arr.forEach(row=>{ const id=String(row.idNumber||row.idnumber||'').trim(); if(!id) return; const nm=String(row.name||'').trim(); const opt=document.createElement('option'); opt.value=id; opt.textContent=nm ? (id+' — '+nm) : id; supSel.appendChild(opt); }); } catch { /* ignore */ } } courseSel.addEventListener('change', updateSupOptions); sectionSel.addEventListener('change', updateSupOptions); form.appendChild(courseSel); form.appendChild(sectionSel); form.appendChild(supSel); if (courses.length===1) { courseSel.value=courses[0]; } if (sections.length===1) { sectionSel.value=sections[0]; } if (courseSel.value && sectionSel.value) { updateSupOptions(); } const actions=document.createElement('div'); actions.className='buttons'; actions.style.display='grid'; actions.style.gridTemplateColumns='1fr'; actions.style.gap='0.5rem'; actions.style.justifyItems='center'; actions.style.width='100%'; actions.style.margin='0'; const addBtn=document.createElement('button'); addBtn.className='role-button'; addBtn.type='submit'; addBtn.style.width='94%'; addBtn.style.margin='0 auto'; addBtn.style.textAlign='center'; addBtn.textContent='Add Student'; const cancelBtn=document.createElement('button'); cancelBtn.className='role-button'; cancelBtn.type='button'; cancelBtn.style.width='94%'; cancelBtn.style.margin='0 auto'; cancelBtn.style.textAlign='center'; cancelBtn.textContent='Cancel'; cancelBtn.addEventListener('click',function(){ overlay.remove(); }); actions.appendChild(addBtn); actions.appendChild(cancelBtn); form.appendChild(actions); form.addEventListener('submit', async function(e){ e.preventDefault(); const f=e.currentTarget; const payload={ idNumber:String(f.idNumber.value||'').trim(), password:String(f.password.value||'').trim(), firstName:String(f.firstName.value||'').trim(), middleName:String(f.middleName.value||'').trim(), lastName:String(f.lastName.value||'').trim(), course:String(f.course.value||'').trim()||null, section:String(f.section.value||'').trim()||null, supervisorId:String(f.supervisorId.value||'').trim()||null }; if(!payload.idNumber || !payload.password || !payload.firstName || !payload.lastName || !payload.course || !payload.section){ alert('Please complete all required fields'); return; } const okC=courses.includes(String(payload.course||'')); const okS=sections.includes(String(payload.section||'')); if(!okC || !okS){ alert('Course and Section must be from your assignments'); return; } try { const resp=await fetch('/api/students', { method:'POST', headers: authHeaders(true), body: JSON.stringify(payload) }); const j=await resp.json().catch(()=>({})); if(resp.ok && j && j.ok){ overlay.remove(); const url='/instructor/students-list.html?course='+encodeURIComponent(String(payload.course))+'&section='+encodeURIComponent(String(payload.section)); window.location.href=url; } else { alert(String((j&&j.error)||'Failed to add student')); } } catch { alert('Network error'); } }); box.appendChild(close); box.appendChild(title); box.appendChild(form); document.body.appendChild(overlay); overlay.appendChild(box); } catch {} }
      document.addEventListener('DOMContentLoaded', async function(){
        const box = document.getElementById('contentBox');
        const addBtn = document.getElementById('addStudentBtn');
        box.innerHTML = '<div class="skeleton-card"><div class="skeleton-line" style="width:60%"></div><div class="skeleton-line" style="width:40%;margin-top:8px"></div></div>';
        try {
          const r = await fetch('/api/instructor/me/assignments', { headers: authHeaders(), cache: 'no-store' });
          const j = await r.json().catch(()=>({}));
          const raw = Array.isArray(j?.data?.sections) ? j.data.sections.filter(Boolean) : [];
          const sections = raw.map(function(item){
            if (typeof item === 'string') return item;
            const course = String(item.course||item.courseCode||'').trim().toUpperCase();
            const section = String(item.section||item.sectionCode||'').trim().toUpperCase();
            return (course && section) ? (course+'-'+section) : (section || course || '');
          }).filter(Boolean);
          if (!sections.length) { box.innerHTML = '<div class="empty">No sections assigned</div>'; return; }
          box.innerHTML = '';
          const grid = document.createElement('div');
          grid.className = 'buttons';
          grid.style.display = 'grid'; grid.style.gridTemplateColumns = 'repeat(3,1fr)'; grid.style.gap = '0.5rem'; grid.style.width = '100%';
          sections.forEach(code => {
            const btn = document.createElement('button'); btn.className = 'role-button'; btn.type='button'; btn.textContent = code;
            btn.addEventListener('click', function(){
              const m = String(code).split('-');
              const course = (m[0] || '').toUpperCase();
              const section = (m[1] || '').toUpperCase();
              const url = '/instructor/students-list.html?course=' + encodeURIComponent(course) + '&section=' + encodeURIComponent(section);
              window.location.href = url;
            });
            grid.appendChild(btn);
          });
          box.appendChild(grid);
          if (addBtn) { const assigns = raw.map(function(item){ return (typeof item==='string') ? { course: String(item).split('-')[0] || '', section: String(item).split('-')[1] || '' } : { course: String(item.course||item.courseCode||'').toUpperCase(), section: String(item.section||item.sectionCode||'').toUpperCase() }; }); addBtn.addEventListener('click', function(){ openAddModal(assigns); setTimeout(hookSupervisorOptions, 0); }); }
        } catch { box.innerHTML = '<div class="empty">Failed to load sections</div>'; }
      });
    </script>
    <script>
      (function(){
        const nav = document.querySelector('.student-nav'); if (!nav) return; nav.classList.add('slideable');
        let startY=null, lastY=null, moved=0;
        function start(e){ const t=e.touches?e.touches[0]:e; startY=t.clientY; lastY=startY; moved=0; }
        function move(e){ const t=e.touches?e.touches[0]:e; lastY=t.clientY; moved=lastY-startY; }
        function end(){ if (moved>30) { document.body.classList.add('nav-hidden'); } else if (moved<-30) { document.body.classList.remove('nav-hidden'); } else { document.body.classList.toggle('nav-hidden'); } startY=null; lastY=null; moved=0; }
        nav.addEventListener('touchstart', start, { passive:true });
        nav.addEventListener('touchmove', move, { passive:true });
        nav.addEventListener('touchend', end);
        nav.addEventListener('mousedown', start);
        nav.addEventListener('mousemove', function(e){ if (startY!==null) move(e); });
        nav.addEventListener('mouseup', end);
      })();
    </script>
  </body>
</html>

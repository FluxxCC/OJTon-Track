<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack ‚Äî Attendance Logs</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container centered">
      <div class="dashboard-main center-page">
        
        <div class="attendance-card" style="margin-top:0.75rem;border-radius:10px">
          <div style="display:flex;align-items:center;gap:8px;justify-content:flex-start;font-size:18px;font-weight:700;margin-bottom:8px">
            <a href="/student/DTR.html" style="font-size:12px;padding:6px 10px;border:1px solid #ccc;border-radius:999px;color:#111;text-decoration:none;background:#fff;display:inline-flex;align-items:center;gap:6px">‚¨ÖÔ∏è <span>Back</span></a>
            <span style="opacity:0.5">|</span>
            <div>Attendance Logs</div>
          </div>
          <div class="search-wrap" style="margin-bottom:8px;position:relative">
            <div id="filtersRow" style="margin-top:6px;display:flex;align-items:center;justify-content:center;gap:8px">
              <button id="openFilter" class="role-button neutral" style="width:auto;padding:6px 10px;border-radius:999px;font-size:12px">Filter Month</button>
            </div>
          </div>
          <div id="logsBox" class="recent-scroll small" style="max-height:60vh; overflow-y:auto; padding-top:6px"><div>Loading‚Ä¶</div></div>
        </div>
      </div>
    </main>
    <div id="photoModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:10px;border-radius:10px;max-width:90%;max-height:85vh;display:flex;flex-direction:column;align-items:center">
        <img id="photoModalImg" src="" alt="photo" style="max-width:100%;max-height:75vh;border-radius:8px" />
        <button id="photoClose" class="role-button outline" style="width:auto;margin-top:10px;padding:6px 14px;border-radius:999px">Close</button>
      </div>
    </div>
    <div id="filterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:12px;border-radius:12px;width:clamp(320px,80vw,560px);max-height:70vh;display:flex;flex-direction:column;gap:10px">
        <div class="recent-label" style="margin:0">Select Month</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <button class="role-button" data-month="" style="grid-column:1 / -1">All months</button>
          <button class="role-button" data-month="0">January</button>
          <button class="role-button" data-month="1">February</button>
          <button class="role-button" data-month="2">March</button>
          <button class="role-button" data-month="3">April</button>
          <button class="role-button" data-month="4">May</button>
          <button class="role-button" data-month="5">June</button>
          <button class="role-button" data-month="6">July</button>
          <button class="role-button" data-month="7">August</button>
          <button class="role-button" data-month="8">September</button>
          <button class="role-button" data-month="9">October</button>
          <button class="role-button" data-month="10">November</button>
          <button class="role-button" data-month="11">December</button>
        </div>
        <button id="filterClose" class="role-button">Close</button>
      </div>
    </div>
    <nav class="student-nav">
      <div class="student-nav-inner">
        <a href="/student/dashboard.html" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5l9-7 9 7"/><path d="M5 11v9h14v-9"/></svg>
        </a>
        <a href="/student/DTR.html" class="active" aria-label="Attendance">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </a>
        <a href="/student/reports.html" aria-label="Reports">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V5a2 2 0 012-2h10"/><path d="M20 7v12a2 2 0 01-2 2H6"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>
        </a>
        <a href="/student/profile.html" aria-label="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </a>
      </div>
    </nav>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config.js"></script>
    <script>
      function authHeaders(json=false){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
      document.addEventListener('DOMContentLoaded', async function(){
        const box = document.getElementById('logsBox');
        const openFilter = document.getElementById('openFilter');
        const filterModal = document.getElementById('filterModal');
        const filterClose = document.getElementById('filterClose');
        let selectedMonth = '';
        let rows = [];
        box.innerHTML = '<div>Loading‚Ä¶</div>';
        try {
          const meR = await fetch('/api/me', { headers: authHeaders() });
          if (!meR.ok) { window.location.replace('/index.html'); return; }
        } catch { window.location.replace('/index.html'); return; }
        try {
          const r = await fetch('/api/attendance/recent', { headers: authHeaders(), cache: 'no-store' });
          const j = await r.json().catch(()=>({}));
          rows = r.ok && j.ok ? (Array.isArray(j.data) ? j.data : []) : [];
        } catch { rows = []; }
        function render(){
          const selected = String(selectedMonth || '').trim();
          let list = rows.slice().sort((a,b)=>Number(b.ts||0)-Number(a.ts||0));
          if (selected) list = list.filter(x => new Date(Number(x.ts||Date.now())).getMonth() === Number(selected));
          if (list.length) {
            box.innerHTML = '';
            list.forEach(x => {
              const d = new Date(Number(x.ts||Date.now()));
              const date = d.toLocaleDateString('en-US',{ month:'long', day:'numeric', year:'numeric' });
              const time = d.toLocaleTimeString('en-US',{ hour:'numeric', minute:'2-digit' });
              const item = document.createElement('div'); item.className='recent-item';
              item.style.padding='10px 12px'; item.style.margin='8px 0'; item.style.borderRadius='12px'; item.style.background='var(--surface-alpha)'; item.style.boxShadow='0 4px 10px rgba(0,0,0,0.08)';
              const title = document.createElement('div'); title.className='recent-title'; title.textContent = String(x.type||'')==='in'?'üïí Time In':'üïí Time Out';
              const sub = document.createElement('div'); sub.className='recent-sub'; sub.textContent = `${date} ‚Ä¢ ${time}`;
              const st = String(x.status||'')==='confirmed'?'Confirmed':(String(x.status||'')==='awaiting_supervisor'?'Pending':'');
              if (st){ const pill=document.createElement('span'); pill.className='status-pill '+(st==='Confirmed'?'status-confirmed':'status-pending'); pill.textContent = (st==='Confirmed' ? ('Confirmed at ' + time) : 'Pending'); sub.appendChild(pill); }
              const actions = document.createElement('div'); actions.className='recent-actions';
              const url = x.photoUrl || x.photourl || '';
              if (url){ const a=document.createElement('a'); a.href='#'; a.textContent='View Photo'; a.addEventListener('click',function(e){ e.preventDefault(); const m=document.getElementById('photoModal'); const img=document.getElementById('photoModalImg'); img.src=url; m.style.display='flex'; }); actions.appendChild(a); }
              item.appendChild(title); item.appendChild(sub); if (actions.childNodes.length) item.appendChild(actions);
              box.appendChild(item);
            });
          } else {
            box.innerHTML = '<div>No attendance logs found</div>';
          }
        }
        render();
        if (openFilter) openFilter.addEventListener('click', function(){ if (filterModal) filterModal.style.display='flex'; });
        if (filterModal) filterModal.addEventListener('click', function(e){ if (e.target === filterModal) filterModal.style.display='none'; });
        if (filterClose) filterClose.addEventListener('click', function(){ if (filterModal) filterModal.style.display='none'; });
        (function(){ const m=document.getElementById('photoModal'); const c=document.getElementById('photoClose'); if (m && c) { m.addEventListener('click', function(e){ if (e.target===m) m.style.display='none'; }); c.addEventListener('click', function(){ m.style.display='none'; }); } })();
        Array.from(document.querySelectorAll('#filterModal [data-month]')).forEach(btn=>{
          btn.addEventListener('click', function(){ selectedMonth = String(this.getAttribute('data-month')||''); render(); if (filterModal) filterModal.style.display='none'; });
        });
        
      });
      (function(){
        const nav = document.querySelector('.student-nav'); if (!nav) return; nav.classList.add('slideable');
        let startY=null, lastY=null, moved=0;
        function start(e){ const t=e.touches?e.touches[0]:e; startY=t.clientY; lastY=startY; moved=0; }
        function move(e){ const t=e.touches?e.touches[0]:e; lastY=t.clientY; moved=lastY-startY; }
        function end(){ if (moved>30) { document.body.classList.add('nav-hidden'); } else if (moved<-30) { document.body.classList.remove('nav-hidden'); } else { document.body.classList.toggle('nav-hidden'); } startY=null; lastY=null; moved=0; }
        nav.addEventListener('touchstart', start, { passive:true });
        nav.addEventListener('touchmove', move, { passive:true });
        nav.addEventListener('touchend', end);
        nav.addEventListener('mousedown', start);
        nav.addEventListener('mousemove', function(e){ if (startY!==null) move(e); });
        nav.addEventListener('mouseup', end);
      })();
    </script>
  </body>
</html>

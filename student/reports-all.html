<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack ‚Äî All Reports</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container centered">
      <div class="dashboard-main center-page">
        
        <div class="attendance-card" style="margin-top:0.75rem;border-radius:10px">
          <div style="display:flex;align-items:center;gap:8px;justify-content:flex-start;font-size:18px;font-weight:700;margin-bottom:8px">
            <a href="/student/reports.html" style="font-size:12px;padding:6px 10px;border:1px solid #ccc;border-radius:999px;color:#111;text-decoration:none;background:#fff;display:inline-flex;align-items:center;gap:6px">‚¨ÖÔ∏è <span>Back</span></a>
            <span style="opacity:0.5">|</span>
            <div>All Reports</div>
          </div>
          <div class="search-wrap" style="margin-bottom:8px;position:relative">
            <div id="filtersRow" style="margin-top:6px;display:flex;align-items:center;justify-content:center;gap:8px">
              <button id="openFilter" class="role-button neutral" style="width:auto;padding:6px 10px;border-radius:999px;font-size:12px">Filter Month</button>
            </div>
          </div>
          <div id="reportsBox" class="recent-scroll small" style="max-height:60vh; overflow-y:auto; padding-top:6px"><div>Loading‚Ä¶</div></div>
        </div>
      </div>
    </main>
      <div id="filterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:12px;border-radius:12px;width:clamp(320px,80vw,560px);max-height:70vh;display:flex;flex-direction:column;gap:10px">
        <div class="recent-label" style="margin:0">Select Month</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <button class="role-button" data-month="" style="grid-column:1 / -1">All months</button>
          <button class="role-button" data-month="0">January</button>
          <button class="role-button" data-month="1">February</button>
          <button class="role-button" data-month="2">March</button>
          <button class="role-button" data-month="3">April</button>
          <button class="role-button" data-month="4">May</button>
          <button class="role-button" data-month="5">June</button>
          <button class="role-button" data-month="6">July</button>
          <button class="role-button" data-month="7">August</button>
          <button class="role-button" data-month="8">September</button>
          <button class="role-button" data-month="9">October</button>
          <button class="role-button" data-month="10">November</button>
          <button class="role-button" data-month="11">December</button>
        </div>
        <button id="filterClose" class="role-button">Close</button>
      </div>
    </div>
    <div id="studentCommentModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:16px;border-radius:12px;width:clamp(320px,80vw,720px);max-height:85vh;display:flex;flex-direction:column;gap:10px">
        <div id="studentCommentList" class="recent-scroll small" style="max-height:60vh;overflow-y:auto"></div>
        <button id="studentCommentClose" class="role-button" style="padding:6px 12px">Close</button>
      </div>
    </div>
    <div id="reportViewModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:16px;border-radius:12px;width:clamp(320px,80vw,720px);max-height:85vh;display:flex;flex-direction:column;gap:10px;position:relative">
        <button id="reportViewClose" class="role-button" style="position:absolute;top:8px;right:8px">Close</button>
        <div class="cam-header" style="margin-top:48px;margin-bottom:4px"><span class="stat-label" id="reportViewTitle"></span></div>
        <div id="reportViewText" class="recent-scroll small" style="max-height:60vh;overflow-y:auto"></div>
      </div>
    </div>
    <nav class="student-nav">
      <div class="student-nav-inner">
        <a href="/student/dashboard.html" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5l9-7 9 7"/><path d="M5 11v9h14v-9"/></svg>
        </a>
        <a href="/student/DTR.html" aria-label="Attendance">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </a>
        <a href="/student/reports.html" class="active" aria-label="Reports">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V5a2 2 0 012-2h10"/><path d="M20 7v12a2 2 0 01-2 2H6"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>
        </a>
        <a href="/student/profile.html" aria-label="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </a>
      </div>
    </nav>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config.js"></script>
    <script>
      function authHeaders(json=false){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
      document.addEventListener('DOMContentLoaded', async function(){
        const box = document.getElementById('reportsBox');
        const openFilter = document.getElementById('openFilter');
        const filterModal = document.getElementById('filterModal');
        const filterClose = document.getElementById('filterClose');
        let selectedMonth = '';
        let rows = [];
        box.innerHTML = '<div>Loading‚Ä¶</div>';
        try {
          const meR = await fetch('/api/me', { headers: authHeaders() });
          if (!meR.ok) { window.location.replace('/index.html'); return; }
        } catch { window.location.replace('/index.html'); return; }
        try {
          const r = await fetch('/api/reports/recent?all=1', { headers: authHeaders(), cache: 'no-store' });
          const j = await r.json().catch(()=>({}));
          rows = r.ok && j.ok ? (Array.isArray(j.data) ? j.data : []) : [];
        } catch { rows = []; }
        async function refresh(){ try { const r = await fetch('/api/reports/recent?all=1', { headers: authHeaders(), cache: 'no-store' }); const j = await r.json().catch(()=>({})); rows = r.ok && j.ok ? (Array.isArray(j.data) ? j.data : rows) : rows; } catch {} render(); }
          function render(){
          const selected = String(selectedMonth || '').trim();
          let list = rows.slice().sort((a,b)=>Number(b.ts||0)-Number(a.ts||0));
          if (selected) list = list.filter(x => new Date(Number(x.ts||Date.now())).getMonth() === Number(selected));
          if (list.length) {
            box.innerHTML = '';
            list.forEach(x => {
              const d = new Date(Number(x.ts||Date.now()));
              const date = d.toLocaleDateString('en-US',{ month:'long', day:'numeric', year:'numeric' });
              const time = d.toLocaleTimeString('en-US',{ hour:'numeric', minute:'2-digit' });
              const el = document.createElement('div'); el.className='recent-item';
              el.style.padding='10px 12px'; el.style.margin='8px 0'; el.style.borderRadius='12px'; el.style.background='var(--surface-alpha)'; el.style.boxShadow='0 4px 10px rgba(0,0,0,0.08)';
              const title = document.createElement('div'); title.className='recent-title';
              const baseTitle = String(x.title||'').trim();
              title.textContent = baseTitle ? `üìÑ Report ‚Äî ${baseTitle}` : 'üìÑ Report';
              const sub = document.createElement('div'); sub.className='recent-sub'; sub.style.opacity='0.8'; sub.style.fontSize='0.9rem'; sub.textContent = `${date} ‚Ä¢ ${time}`;
              const rawStatus = String(x.status||'').toLowerCase();
              const statusLabel = rawStatus==='under_review' ? 'Under Review' : (rawStatus==='accepted' ? 'Accepted' : (rawStatus.includes('draft') ? 'Draft' : 'Submitted'));
              const pill=document.createElement('span');
              const pillClass = statusLabel==='Under Review' ? 'status-submitted' : (statusLabel==='Accepted' ? 'status-confirmed' : (statusLabel==='Draft' ? 'status-draft' : 'status-submitted'));
              pill.className='status-pill '+pillClass;
              pill.textContent = statusLabel;
              sub.appendChild(pill);
              const actions = document.createElement('div'); actions.className='recent-actions'; actions.style.display='flex'; actions.style.alignItems='center'; actions.style.justifyContent='center'; actions.style.gap='8px'; actions.style.marginTop='8px';
              const files = Array.isArray(x.files) ? x.files : [];
              const first = files[0] || {};
              const viewBtn = document.createElement('button'); viewBtn.className='role-button neutral'; viewBtn.type='button'; viewBtn.style.width='32px'; viewBtn.style.height='32px'; viewBtn.style.padding='0'; viewBtn.style.display='flex'; viewBtn.style.alignItems='center'; viewBtn.style.justifyContent='center'; viewBtn.style.border='1px solid #d1d5db'; viewBtn.style.borderRadius='8px'; viewBtn.style.background='#fff'; viewBtn.style.color='#6b7280'; viewBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg>';
              const vs = viewBtn.querySelector('svg'); if (vs) { vs.setAttribute('width','20'); vs.setAttribute('height','20'); vs.setAttribute('stroke','currentColor'); }
              const cmtBtn = document.createElement('button'); cmtBtn.className='role-button neutral'; cmtBtn.type='button'; cmtBtn.style.width='32px'; cmtBtn.style.height='32px'; cmtBtn.style.padding='0'; cmtBtn.style.display='flex'; cmtBtn.style.alignItems='center'; cmtBtn.style.justifyContent='center'; cmtBtn.style.border='1px solid #d1d5db'; cmtBtn.style.borderRadius='8px'; cmtBtn.style.background='#fff'; cmtBtn.style.color='#6b7280'; cmtBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a4 4 0 01-4 4H7l-4 4V7a4 4 0 014-4h10a4 4 0 014 4v8z"/></svg>';
              const cs = cmtBtn.querySelector('svg'); if (cs) { cs.setAttribute('width','20'); cs.setAttribute('height','20'); cs.setAttribute('stroke','currentColor'); }
              const badge = document.createElement('span'); badge.style.display='none'; badge.style.position='absolute'; badge.style.width='10px'; badge.style.height='10px'; badge.style.background='#ef4444'; badge.style.borderRadius='50%'; cmtBtn.style.position='relative'; badge.style.top='-4px'; badge.style.right='-4px'; cmtBtn.appendChild(badge);
              viewBtn.addEventListener('click', function(){ openView(x); });
              cmtBtn.addEventListener('click', function(){ openCommentsFor(x.id, badge); });
              if (first && first.url) {
                const dl = document.createElement('a');
                dl.href = String(first.url);
                dl.target = '_blank';
                dl.rel = 'noreferrer';
                if (first.name) dl.setAttribute('download', String(first.name));
                dl.className='role-button neutral';
                dl.style.width='32px'; dl.style.height='32px'; dl.style.padding='0'; dl.style.display='flex'; dl.style.alignItems='center'; dl.style.justifyContent='center'; dl.style.border='1px solid #d1d5db'; dl.style.borderRadius='8px'; dl.style.background='#fff'; dl.style.color='#6b7280';
                dl.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="M8 11l4 4 4-4"/><path d="M5 19h14"/></svg>';
                const s=dl.querySelector('svg'); if(s){ s.setAttribute('width','20'); s.setAttribute('height','20'); s.setAttribute('stroke','currentColor'); }
                actions.appendChild(dl);
              } else {
                actions.appendChild(viewBtn);
              }
              actions.appendChild(cmtBtn);
              el.appendChild(title); el.appendChild(sub); if (actions.childNodes.length) el.appendChild(actions);
              box.appendChild(el);
              (async function(){ try{ if (sessionStorage.getItem('rep:dismissed:'+String(x.id||''))) { badge.style.display='none'; return; } } catch {} try{ const ur = await fetch(`/api/reports/${encodeURIComponent(String(x.id||''))}/comments/unread`, { headers: authHeaders() }); const uj = await ur.json(); const c = (ur.ok && uj.ok) ? Number(uj.count||0) : 0; badge.style.display = c > 0 ? 'block' : 'none'; } catch { badge.style.display = 'none'; } })();
            });
          } else {
            box.innerHTML = '<div>No reports found</div>';
          }
        }
        render();
        try { const meR = await fetch('/api/me', { headers: authHeaders() }); const meJ = await meR.json().catch(()=>({})); const idNumber = String(meJ.data?.id_number || meJ.data?.idNumber || ''); const sb = window.supabase?.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY); if (sb && idNumber) { sb.channel('rep:' + idNumber).on('postgres_changes', { event:'*', schema:'public', table:'reports', filter:'idnumber=eq.'+idNumber }, function(){ refresh(); }).on('postgres_changes', { event:'INSERT', schema:'public', table:'report_comments', filter:'idnumber=eq.'+idNumber }, function(payload){ try { const rid = String(payload?.new?.reportid || ''); if (rid) sessionStorage.removeItem('rep:dismissed:'+rid); } catch {} refresh(); }).subscribe(); } } catch {}
        async function openCommentsFor(id, badgeEl){ const m=document.getElementById('studentCommentModal'); const list=document.getElementById('studentCommentList'); const closeBtn=document.getElementById('studentCommentClose'); list.innerHTML=''; try{ const r=await fetch(`/api/reports/${encodeURIComponent(String(id||''))}/comments`, { headers: authHeaders() }); const j=await r.json(); const rows=(r.ok&&j.ok&&Array.isArray(j.data))?j.data:[]; list.innerHTML=''; rows.forEach(c=>{ const line=document.createElement('div'); line.textContent=String(c.text||''); list.appendChild(line); }); } catch { list.innerHTML=''; } try{ await fetch(`/api/reports/${encodeURIComponent(String(id||''))}/comments/read`, { method:'POST', headers: authHeaders(true) }); if (badgeEl) badgeEl.style.display='none'; try { sessionStorage.setItem('rep:dismissed:'+String(id||''), '1'); } catch {} } catch {} m.style.display='flex'; if (closeBtn) closeBtn.addEventListener('click', function(){ m.style.display='none'; }); m.addEventListener('click', function(e){ if (e.target===m) m.style.display='none'; }); }
        function openView(x){ const m=document.getElementById('reportViewModal'); const t=document.getElementById('reportViewTitle'); const body=document.getElementById('reportViewText'); const hasFiles=Array.isArray(x.files)&&x.files.length>0; const baseTitle=String(x.title||'').trim(); t.textContent= baseTitle || (hasFiles ? 'File upload' : '(No title)'); body.textContent=String(x.text||'').trim()||'(No content)'; m.style.display='flex'; const closeBtn=document.getElementById('reportViewClose'); if (closeBtn) closeBtn.addEventListener('click', function(){ m.style.display='none'; }); m.addEventListener('click', function(e){ if (e.target===m) m.style.display='none'; }); }
        if (openFilter) openFilter.addEventListener('click', function(){ if (filterModal) filterModal.style.display='flex'; });
        if (filterModal) filterModal.addEventListener('click', function(e){ if (e.target === filterModal) filterModal.style.display='none'; });
        if (filterClose) filterClose.addEventListener('click', function(){ if (filterModal) filterModal.style.display='none'; });
        Array.from(document.querySelectorAll('#filterModal [data-month]')).forEach(btn=>{
          btn.addEventListener('click', function(){ selectedMonth = String(this.getAttribute('data-month')||''); render(); if (filterModal) filterModal.style.display='none'; });
        });
        
      });
      (function(){
        const nav = document.querySelector('.student-nav'); if (!nav) return; nav.classList.add('slideable');
        let startY=null, lastY=null, moved=0;
        function start(e){ const t=e.touches?e.touches[0]:e; startY=t.clientY; lastY=startY; moved=0; }
        function move(e){ const t=e.touches?e.touches[0]:e; lastY=t.clientY; moved=lastY-startY; }
        function end(){ if (moved>30) { document.body.classList.add('nav-hidden'); } else if (moved<-30) { document.body.classList.remove('nav-hidden'); } else { document.body.classList.toggle('nav-hidden'); } startY=null; lastY=null; moved=0; }
        nav.addEventListener('touchstart', start, { passive:true });
        nav.addEventListener('touchmove', move, { passive:true });
        nav.addEventListener('touchend', end);
        nav.addEventListener('mousedown', start);
        nav.addEventListener('mousemove', function(e){ if (startY!==null) move(e); });
        nav.addEventListener('mouseup', end);
      })();
    </script>
  </body>
</html>

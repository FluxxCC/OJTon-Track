<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack â€” Profile</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container centered">
      <div class="dashboard-main center-page">
        <h2 class="welcome">Student Profile</h2>
        <div class="attendance-card" id="profileBox">
          <div style="display:grid;gap:8px;text-align:left">
            <div id="pName" class="stat-label">Name: </div>
            <div id="pCourse" class="stat-label">Course: </div>
            <div id="pSection" class="stat-label">Section: </div>
          </div>
          <div class="buttons" style="margin-top:12px">
            <button id="changePwBtn" class="role-button" style="width:100%">Change Password</button>
            <button id="logoutBtn" class="role-button" style="width:100%">Logout</button>
          </div>
        </div>
      </div>
    </main>
    <div id="pwModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:12px;border-radius:12px;width:clamp(320px,80vw,560px);display:flex;flex-direction:column;gap:8px">
        <div class="recent-label" style="margin:0;text-align:center">Change Password</div>
        <input id="pwCurrent" class="input" type="password" placeholder="Current password" style="width:100%;border:1px solid #ccc" />
        <input id="pwNew" class="input" type="password" placeholder="New password" style="width:100%;border:1px solid #ccc" />
        <input id="pwConfirm" class="input" type="password" placeholder="Re-type new password" style="width:100%;border:1px solid #ccc" />
        <div class="buttons" style="display:flex;gap:8px;justify-content:center;width:100%">
          <button id="pwSave" class="role-button primary" style="min-width:120px;border-radius:9999px;padding:10px 16px">Save Changes</button>
          <button id="pwCancel" class="role-button" style="min-width:120px;border-radius:9999px;padding:10px 16px">Cancel</button>
        </div>
      </div>
    </div>
    <nav class="student-nav">
      <div class="student-nav-inner">
        <a href="/student/dashboard.html" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5l9-7 9 7"/><path d="M5 11v9h14v-9"/></svg>
        </a>
        <a href="/student/DTR.html" aria-label="Attendance">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </a>
        <a href="/student/reports.html" aria-label="Reports">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V5a2 2 0 012-2h10"/><path d="M20 7v12a2 2 0 01-2 2H6"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>
        </a>
        <a href="/student/profile.html" class="active" aria-label="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </a>
      </div>
    </nav>
    <script>
      async function ensureAuth() { const r = await fetch('/api/me'); if (!r.ok) { window.location.replace('/index.html'); throw new Error('auth'); } return r.json(); }
      document.addEventListener('DOMContentLoaded', async function() {
        try {
          const j = await ensureAuth();
          const name = j.data?.name || '';
          const course = j.data?.course || '';
          const section = j.data?.section || '';
          document.getElementById('pName').textContent = `Name: ${name}`;
          document.getElementById('pCourse').textContent = `Course: ${course}`;
          document.getElementById('pSection').textContent = `Section: ${section}`;
        } catch {}
        document.getElementById('logoutBtn').addEventListener('click', async function(){
          try { await fetch('/api/logout', { method: 'POST' }); } catch {}
          try { sessionStorage.removeItem('selectedRole'); sessionStorage.removeItem('userAuth'); sessionStorage.removeItem('userToken'); sessionStorage.removeItem('role'); } catch {}
          try { localStorage.removeItem('selectedRole'); localStorage.removeItem('userAuth'); localStorage.removeItem('userToken'); localStorage.removeItem('role'); } catch {}
          window.location.href = '/';
        });
        const pwModal = document.getElementById('pwModal');
        const changePwBtn = document.getElementById('changePwBtn');
        const pwSave = document.getElementById('pwSave');
        const pwCancel = document.getElementById('pwCancel');
        const pwCurrent = document.getElementById('pwCurrent');
        const pwNew = document.getElementById('pwNew');
        const pwConfirm = document.getElementById('pwConfirm');
        function openPw(){ if (pwModal) pwModal.style.display='flex'; }
        function closePw(){ if (pwModal) pwModal.style.display='none'; }
        if (changePwBtn) changePwBtn.addEventListener('click', openPw);
        if (pwCancel) pwCancel.addEventListener('click', closePw);
        if (pwModal) pwModal.addEventListener('click', function(e){ if (e.target===pwModal) closePw(); });
        if (pwSave) pwSave.addEventListener('click', async function(){
          const cur = String(pwCurrent.value||'').trim();
          const nw = String(pwNew.value||'').trim();
          const cf = String(pwConfirm.value||'').trim();
          if (!cur || !nw || !cf) { alert('Please fill in all fields'); return; }
          if (nw !== cf) { alert('New passwords do not match'); return; }
          if (nw.length < 6) { alert('New password must be at least 6 characters'); return; }
          pwSave.disabled = true;
          try {
            const hdrs = { 'Content-Type': 'application/json' };
            try { const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); if (t) hdrs.Authorization = 'Bearer ' + t; } catch {}
            const r = await fetch('/api/change-password', { method: 'POST', headers: hdrs, body: JSON.stringify({ currentPassword: cur, newPassword: nw }) });
            const j = await r.json().catch(()=>({}));
            if (r.ok && j && j.ok) { alert('Password changed successfully'); closePw(); pwCurrent.value=''; pwNew.value=''; pwConfirm.value=''; }
            else { alert((j && j.error) || 'Failed to change password'); }
          } catch { alert('Network error'); }
          pwSave.disabled = false;
        });
      });
    </script>
    <script>
      (function(){
        const nav = document.querySelector('.student-nav'); if (!nav) return; nav.classList.add('slideable');
        let startY=null, lastY=null, moved=0;
        function start(e){ const t=e.touches?e.touches[0]:e; startY=t.clientY; lastY=startY; moved=0; }
        function move(e){ const t=e.touches?e.touches[0]:e; lastY=t.clientY; moved=lastY-startY; }
        function end(){ if (moved>30) { document.body.classList.add('nav-hidden'); } else if (moved<-30) { document.body.classList.remove('nav-hidden'); } else { document.body.classList.toggle('nav-hidden'); } startY=null; lastY=null; moved=0; }
        nav.addEventListener('touchstart', start, { passive:true });
        nav.addEventListener('touchmove', move, { passive:true });
        nav.addEventListener('touchend', end);
        nav.addEventListener('mousedown', start);
        nav.addEventListener('mousemove', function(e){ if (startY!==null) move(e); });
        nav.addEventListener('mouseup', end);
      })();
    </script>
  </body>
</html>

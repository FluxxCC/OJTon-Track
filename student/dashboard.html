<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack â€” Student Dashboard</title>
    <meta name="theme-color" content="#111827" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container centered">
      <div class="dashboard-main center-page">
        <div class="hero-header">
          <div class="hero-text">
            <h2 class="welcome hero-title">Welcome, <span id="userName">Name</span>!</h2>
            <p class="subtitle hero-sub">Youâ€™re on track with OJTonTrack ðŸš€</p>
          </div>
        </div>
        <div class="stat" style="padding:12px 14px;border-radius:12px;background:var(--surface-alpha);box-shadow:0 6px 14px rgba(0,0,0,0.08);display:flex;align-items:center;gap:10px">
          <span class="stat-label" style="font-weight:800">Total Accumulated Hours</span>
          <span class="stat-value" id="hours" style="margin-left:auto;font-size:1.4rem;font-weight:800">0h</span>
        </div>
        <div class="recent-label">Recent Activity</div>
        <div class="recent-scroll small" id="recentBox" style="max-height:52vh"><div>No activity yet</div></div>
      </div>
    </main>
    <div id="photoModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:10px;border-radius:10px;max-width:90%;max-height:85vh;display:flex;flex-direction:column;align-items:center">
        <img id="photoModalImg" src="" alt="photo" style="max-width:100%;max-height:75vh;border-radius:8px" />
        <button id="photoClose" class="role-button outline" style="width:auto;margin-top:10px;padding:6px 14px;border-radius:999px">Close</button>
      </div>
    </div>
    <nav class="student-nav" style="box-shadow:0 -6px 14px rgba(0,0,0,0.08)">
      <div class="student-nav-inner">
        <a href="/student/dashboard.html" class="active" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5l9-7 9 7"/><path d="M5 11v9h14v-9"/></svg>
        </a>
        <a href="/student/DTR.html" aria-label="Attendance">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </a>
        <a href="/student/reports.html" aria-label="Reports">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V5a2 2 0 012-2h10"/><path d="M20 7v12a2 2 0 01-2 2H6"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>
        </a>
        <a href="/student/profile.html" aria-label="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </a>
      </div>
    </nav>
    <script>
      function authHeaders(json=false){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
      document.addEventListener('DOMContentLoaded', async function() {
        const box = document.getElementById('recentBox');
        box.innerHTML = '<div>Loadingâ€¦</div>';
        let hasAny = false;
        try {
          const r = await fetch('/api/me', { headers: authHeaders() });
          if (!r.ok) { window.location.replace('/index.html'); return; }
          const j = await r.json();
          if (j.ok && j.data && j.data.name) {
            document.getElementById('userName').textContent = j.data.name;
          }
          const idNumber = j.data?.id_number || j.data?.idNumber || null;
          try {
            const hrsRes = await fetch('/api/attendance/accumulated-hours', { headers: authHeaders() });
            const hrsJ = await hrsRes.json().catch(()=>({}));
            const data = hrsRes.ok && hrsJ.ok ? (hrsJ.data || null) : null;
            const hEl = document.getElementById('hours');
            if (data && hEl) {
              hEl.textContent = data.formatted || '0h 0m 0s';
              if (data.ongoing && typeof data.openStartTs === 'number') {
                const closed = Number(data.closedMilliseconds || 0);
                const openTs = Number(data.openStartTs);
                function fmt(v){ const sec=Math.max(0, Math.ceil(v/1000)); const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); const s=Math.max(0, sec%60); return `${h}h ${m}m ${s}s`; }
                const init = closed + Math.max(0, Date.now() - openTs);
                hEl.textContent = fmt(init);
                if (window.__accHrsTimer) clearInterval(window.__accHrsTimer);
                window.__accHrsTimer = setInterval(function(){ const cur = closed + Math.max(0, Date.now() - openTs); hEl.textContent = fmt(cur); }, 1000);
              } else { if (window.__accHrsTimer) { clearInterval(window.__accHrsTimer); window.__accHrsTimer = null; } }
            }
          } catch {}
          try {
            const [attRes, repRes] = await Promise.all([
              fetch('/api/attendance/recent', { headers: authHeaders() }),
              fetch('/api/reports/recent', { headers: authHeaders() })
            ]);
            const [attJson, repJson] = await Promise.all([attRes.json().catch(() => ({})), repRes.json().catch(() => ({}))]);
            const now = Date.now();
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
            const cutoff = now - sevenDaysMs;
            const attRows = attRes.ok && attJson.ok ? (Array.isArray(attJson.data) ? attJson.data.filter(x=>Number(x.ts||0)>=cutoff) : []) : [];
            const repRows = repRes.ok && repJson.ok ? (Array.isArray(repJson.data) ? repJson.data.filter(x=>Number(x.ts||0)>=cutoff) : []) : [];
            const all = [];
            for (const x of attRows) all.push({ kind: 'attendance', ts: Number(x.ts || 0), data: x });
            for (const x of repRows) all.push({ kind: 'report', ts: Number(x.ts || 0), data: x });
            if (all.length) {
              hasAny = true;
              box.innerHTML = '';
              all.sort((a, b) => Number(b.ts || 0) - Number(a.ts || 0));
              all.forEach(item => {
                const x = item.data;
                const d = new Date(item.ts);
                const date = d.toLocaleDateString('en-US',{ month:'long', day:'numeric', year:'numeric' });
                const time = d.toLocaleTimeString('en-US',{ hour:'numeric', minute:'2-digit' });
                const el = document.createElement('div'); el.className='recent-item';
                el.style.padding='10px 12px'; el.style.margin='8px 0'; el.style.borderRadius='12px'; el.style.background='var(--surface-alpha)'; el.style.boxShadow='0 4px 10px rgba(0,0,0,0.08)';
                const title = document.createElement('div'); title.className='recent-title';
                const sub = document.createElement('div'); sub.className='recent-sub'; sub.style.opacity='0.8'; sub.style.fontSize='0.9rem';
                const actions = document.createElement('div'); actions.className='recent-actions';
                if (item.kind === 'attendance') {
                  title.textContent = (x.type === 'in' ? 'ðŸ•’ Time In' : 'ðŸ•’ Time Out');
                  sub.textContent = `${date} â€¢ ${time}`;
                  const st = String(x.status||'')==='confirmed'?'Confirmed':(String(x.status||'')==='awaiting_supervisor'?'Pending':'');
                  if (st){ const pill=document.createElement('span'); pill.className='status-pill '+(st==='Confirmed'?'status-confirmed':'status-pending'); pill.textContent = (st==='Confirmed' ? ('Confirmed at ' + time) : 'Pending'); sub.appendChild(pill); }
                  if (x.photoUrl) {
                    const a = document.createElement('a'); a.href='#'; a.textContent='View Photo';
                    a.addEventListener('click',(e)=>{ e.preventDefault(); const m=document.getElementById('photoModal'); const img=document.getElementById('photoModalImg'); img.src=x.photoUrl; m.style.display='flex'; });
                    actions.appendChild(a);
                  }
                } else {
                  { const t = String(x.title||'').trim(); title.textContent = t ? `ðŸ“„ Report â€” ${t}` : 'ðŸ“„ Report'; }
                  const rawStatus = String(x.status||'').toLowerCase();
                  const statusLabel = rawStatus==='under_review' ? 'Under Review' : (rawStatus==='accepted' ? 'Accepted' : (rawStatus.includes('draft') ? 'Draft' : 'Submitted'));
                  sub.textContent = `${date} â€¢ ${time}`;
                  const pill=document.createElement('span');
                  const pillClass = statusLabel==='Under Review' ? 'status-submitted' : (statusLabel==='Accepted' ? 'status-confirmed' : (statusLabel==='Draft' ? 'status-draft' : 'status-submitted'));
                  pill.className='status-pill '+pillClass;
                  pill.textContent = statusLabel; sub.appendChild(pill);
                  const files = Array.isArray(x.files) ? x.files : [];
                  const url = files.find(f => f && f.url)?.url;
                  if (url) { const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noreferrer'; a.textContent = 'View File'; actions.appendChild(a); }
                  // Student dashboard does not include instructor acceptance controls
                }
                el.appendChild(title); el.appendChild(sub); if (actions.childNodes.length) el.appendChild(actions);
                box.appendChild(el);
              });
            }
          } catch {}
        } catch { window.location.replace('/index.html'); return; }
        const modal = document.getElementById('photoModal');
        const closeBtn = document.getElementById('photoClose');
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display='none'; });
        closeBtn.addEventListener('click', () => { modal.style.display='none'; });
        if (!hasAny) box.innerHTML = '<div>No activity in the last 7 days</div>';
      });
    </script>
    <script>
      (function(){
        const nav = document.querySelector('.student-nav'); if (!nav) return; nav.classList.add('slideable');
        let startY=null, lastY=null, moved=0;
        function start(e){ const t=e.touches?e.touches[0]:e; startY=t.clientY; lastY=startY; moved=0; }
        function move(e){ const t=e.touches?e.touches[0]:e; lastY=t.clientY; moved=lastY-startY; }
        function end(){ if (moved>30) { document.body.classList.add('nav-hidden'); } else if (moved<-30) { document.body.classList.remove('nav-hidden'); } else { document.body.classList.toggle('nav-hidden'); } startY=null; lastY=null; moved=0; }
        nav.addEventListener('touchstart', start, { passive:true });
        nav.addEventListener('touchmove', move, { passive:true });
        nav.addEventListener('touchend', end);
        nav.addEventListener('mousedown', start);
        nav.addEventListener('mousemove', function(e){ if (startY!==null) move(e); });
        nav.addEventListener('mouseup', end);
      })();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('/service-worker.js').catch(function(){});
      });
    }
  </script>
  </body>
</html>

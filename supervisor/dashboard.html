<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack â€” Supervisor Dashboard</title>
    <meta name="theme-color" content="#111827" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="/config.js"></script>
  </head>
  <body>
    <main class="container centered">
      <div class="dashboard-main center-page">
        <h2 class="welcome">Welcome back, <span id="lastName">Supervisor</span>!</h2>
        <p class="subtitle accent">Youâ€™re on track with OJTonTrack ðŸš€</p>
        <div class="attendance-card">
          <div style="font-size:18px;font-weight:700;margin-bottom:8px">Students Under Supervision</div>
        <div id="studentsBox" class="recent-scroll small" style="text-align:left"><div>Loadingâ€¦</div></div>
        </div>
        <div class="recent-label">Recent Activity</div>
        <div class="recent-scroll small" id="recentBox"><div>Loadingâ€¦</div></div>
      </div>
    </main>
    <div id="photoModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:10px;border-radius:10px;max-width:90%;max-height:85vh;display:flex;flex-direction:column;align-items:center">
        <img id="photoModalImg" src="" alt="photo" style="max-width:100%;max-height:75vh;border-radius:8px" />
        <button id="photoClose" class="role-button outline" style="width:auto;margin-top:10px;padding:6px 14px;border-radius:999px">Close</button>
      </div>
    </div>
    <nav class="student-nav">
      <div class="student-nav-inner">
        <a href="/supervisor/dashboard.html" class="active" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5l9-7 9 7"/><path d="M5 11v9h14v-9"/></svg>
        </a>
        <a href="/supervisor/attendance.html" aria-label="Attendance">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </a>
        <a href="/supervisor/students-logs.html" aria-label="Logs">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V5a2 2 0 012-2h10"/><path d="M20 7v12a2 2 0 01-2 2H6"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>
        </a>
        <a href="/supervisor/profile.html" aria-label="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </a>
      </div>
    </nav>
    <script>
      function authHeaders(json=false){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
      async function ensureAuth() { const r = await fetch('/api/me', { headers: authHeaders(), cache: 'no-store' }); if (!r.ok) { window.location.replace('/index.html'); throw new Error('auth'); } return r.json(); }
      function getLastName(full) { const p = String(full||'').trim().split(/\s+/); return p.length ? p[p.length-1] : full || ''; }
      document.addEventListener('DOMContentLoaded', async function() {
        async function reloadAll(){
          let nameMap = new Map();
          function fmt(ms){ const sec=Math.max(0, Math.ceil(ms/1000)); const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); const s=Math.max(0, sec%60); return `${h}h ${m}m ${s}s`; }
          const studentsBox = document.getElementById('studentsBox');
          studentsBox.innerHTML = '<div>Loadingâ€¦</div>';
          try {
            const r = await fetch('/api/supervisor/students', { headers: authHeaders(), cache: 'no-store' });
            const j = await r.json();
            const rows = r.ok && j.ok ? (Array.isArray(j.data) ? j.data : []) : [];
            nameMap = new Map((rows||[]).map(s => [String(s.idNumber||s.id_number||''), String(s.name||s.idNumber||'').trim().split(/\s+/)[0]]));
            let timers = window.__supTimers || new Map();
            let hoursMap = new Map();
            try {
              const aRes = await fetch('/api/supervisor/attendance/confirmed', { headers: authHeaders(), cache: 'no-store' });
              const aJ = await aRes.json().catch(()=>({}));
              const att = aRes.ok && aJ.ok ? (Array.isArray(aJ.data) ? aJ.data : []) : [];
              const byStudent = new Map();
              att.forEach(x => { const id=String(x.idNumber||x.idnumber||''); if(!id) return; if(!byStudent.has(id)) byStudent.set(id, []); const a=Number(Date.parse(String(x.approvedat||''))||0); const ts=a||Number(x.ts||0); byStudent.get(id).push({ ts, type:String(x.type||'') }); });
              const now = Date.now();
              for (const [id, list] of byStudent.entries()){
                list.sort((a,b)=>Number(a.ts||0)-Number(b.ts||0));
                let open=null, closed=0;
                for(const r of list){ if(r.type==='in'){ open=r.ts; } else if(r.type==='out' && open!==null){ if(r.ts>open) closed += r.ts-open; open=null; } }
                let total=closed; if(open!==null) total += Math.max(0, now-open);
                hoursMap.set(id, { closedMilliseconds: closed, openStartTs: open, formatted: fmt(total) });
              }
            } catch {}
            if (!rows.length) { studentsBox.innerHTML = '<div>No students assigned</div>'; }
            else {
              studentsBox.innerHTML = '';
              rows.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')));
              rows.forEach((s,i)=>{
                const d=document.createElement('div');
                const id=String(s.idNumber||s.id_number||'');
                const h=hoursMap.get(id);
                const label=document.createElement('span'); label.textContent = `${i+1}. ${s.name}`;
                const time=document.createElement('span'); time.style.marginLeft='6px'; time.style.fontWeight='700'; time.textContent = h ? ' â€” '+h.formatted : '';
                d.appendChild(label); d.appendChild(time);
                studentsBox.appendChild(d);
                const key=id;
                if (h && h.openStartTs){
                  if (timers.has(key)) { try { clearInterval(timers.get(key)); } catch {} }
                  const closed=Number(h.closedMilliseconds||0); const open=Number(h.openStartTs||0);
                  const fn = function(){ const now=Date.now(); const total=closed + Math.max(0, now-open); time.textContent = ' â€” ' + fmt(total); };
                  fn();
                  const iv = setInterval(fn, 1000);
                  timers.set(key, iv);
                } else {
                  if (timers.has(key)) { try { clearInterval(timers.get(key)); } catch {} timers.delete(key); }
                }
                window.__supTimers = timers;
              });
            }
          } catch { studentsBox.innerHTML = '<div>No students assigned</div>'; }
          const recentBox = document.getElementById('recentBox');
          recentBox.innerHTML = '<div>Loadingâ€¦</div>';
          try {
            const r = await fetch('/api/supervisor/activity', { headers: authHeaders(), cache: 'no-store' });
            const j = await r.json();
            const now = Date.now();
            const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
            const cutoff = now - sevenDaysMs;
            const rowsAll = r.ok && j.ok ? (Array.isArray(j.data) ? j.data : []) : [];
            const rows = rowsAll
              .filter(x => { const t = Number(new Date(x.ts).getTime() || 0); return t >= cutoff; })
              .sort((a,b)=>Number(new Date(b.ts).getTime()||0)-Number(new Date(a.ts).getTime()||0));
            if (!rows.length) { recentBox.innerHTML = '<div>No activity in the last 7 days</div>'; }
            else {
              recentBox.innerHTML = '';
              rows.forEach(x => {
                const d = new Date(x.ts);
                const date = d.toLocaleDateString('en-US',{ month:'long', day:'numeric', year:'numeric' });
                const time = d.toLocaleTimeString('en-US',{ hour:'numeric', minute:'2-digit' });
                const el = document.createElement('div'); el.className='recent-item';
                el.style.padding='10px 12px'; el.style.margin='8px 0'; el.style.borderRadius='12px'; el.style.background='var(--surface-alpha)'; el.style.boxShadow='0 4px 10px rgba(0,0,0,0.08)';
                const title = document.createElement('div'); title.className='recent-title'; title.textContent = x.type==='in' ? 'ðŸ•’ Time In' : 'ðŸ•’ Time Out';
                const who = String(x.name || nameMap.get(String(x.idNumber||'')) || x.idNumber || '').trim();
                const sub = document.createElement('div'); sub.className='recent-sub'; sub.style.opacity='0.8'; sub.style.fontSize='0.9rem'; sub.textContent = `${who} â€¢ ${date} â€¢ ${time}`;
                const st = String(x.status||'').toLowerCase();
                const pill = document.createElement('span'); pill.className = 'status-pill ' + (st==='confirmed' ? 'status-confirmed' : 'status-pending');
                pill.textContent = st==='confirmed' ? ('Confirmed at ' + time) : 'Pending';
                sub.appendChild(pill);
                const actions = document.createElement('div'); actions.className='recent-actions'; actions.style.display='flex'; actions.style.alignItems='center'; actions.style.justifyContent='center'; actions.style.gap='8px'; actions.style.marginTop='8px';
                const url = x.photoUrl || x.photourl || '';
                if (url) {
                  const a = document.createElement('a'); a.href='#'; a.textContent='View Photo';
                  a.addEventListener('click', function(e){ e.preventDefault(); const m=document.getElementById('photoModal'); const img=document.getElementById('photoModalImg'); img.src=url; m.style.display='flex'; });
                  actions.appendChild(a);
                }
                el.appendChild(title); el.appendChild(sub); if (actions.childNodes.length) el.appendChild(actions);
                recentBox.appendChild(el);
              });
            }
          } catch { recentBox.innerHTML = '<div>No activity yet</div>'; }
        }
        try {
          const me = await ensureAuth();
          const ln = String(me.data?.lastName || '').trim() || getLastName(me.data?.name || '');
          document.getElementById('lastName').textContent = ln || (me.data?.name || '');
          await reloadAll();
          const course = String(me.data?.course || me.data?.courseCode || '');
          const sb = window.supabase?.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
          if (sb) {
            let listenA = { event:'*', schema:'public', table:'attendance' };
            if (course) listenA = { event:'*', schema:'public', table:'attendance', filter:'course=eq.'+course };
            const ch = sb.channel('sup-dashboard:'+(course||'all'));
            ch.on('postgres_changes', listenA, reloadAll);
            ch.on('broadcast', { event:'attendance' }, reloadAll);
            ch.subscribe();
          }
          // Push subscription for notifications
          try {
            if ('Notification' in window && 'serviceWorker' in navigator) {
              const perm = await Notification.requestPermission();
              if (perm === 'granted') {
                const reg = await navigator.serviceWorker.ready;
                const resp = await fetch('/api/push/public-key', { headers: authHeaders(), cache: 'no-store' });
                const jpk = await resp.json().catch(()=>({}));
                const key = (resp.ok && jpk.ok && jpk.key) ? jpk.key : null;
                function urlBase64ToUint8Array(base64String){ const padding='='.repeat((4-base64String.length%4)%4); const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/'); const rawData=window.atob(base64); const outputArray=new Uint8Array(rawData.length); for(let i=0;i<rawData.length;++i){ outputArray[i]=rawData.charCodeAt(i);} return outputArray; }
                if (key) {
                  const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(key) });
                  await fetch('/api/push/subscribe', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ subscription: sub }) });
                }
              }
            }
          } catch {}
        } catch {}
        const modal = document.getElementById('photoModal');
        const closeBtn = document.getElementById('photoClose');
        if (modal && closeBtn) {
          modal.addEventListener('click', function(e){ if (e.target===modal) modal.style.display='none'; });
          closeBtn.addEventListener('click', function(){ modal.style.display='none'; });
        }
      });
    </script>
    <script>
      (function(){
        const nav = document.querySelector('.student-nav'); if (!nav) return; nav.classList.add('slideable');
        let startY=null, lastY=null, moved=0;
        function start(e){ const t=e.touches?e.touches[0]:e; startY=t.clientY; lastY=startY; moved=0; }
        function move(e){ const t=e.touches?e.touches[0]:e; lastY=t.clientY; moved=lastY-startY; }
        function end(){ if (moved>30) { document.body.classList.add('nav-hidden'); } else if (moved<-30) { document.body.classList.remove('nav-hidden'); } else { document.body.classList.toggle('nav-hidden'); } startY=null; lastY=null; moved=0; }
        nav.addEventListener('touchstart', start, { passive:true });
        nav.addEventListener('touchmove', move, { passive:true });
        nav.addEventListener('touchend', end);
        nav.addEventListener('mousedown', start);
        nav.addEventListener('mousemove', function(e){ if (startY!==null) move(e); });
        nav.addEventListener('mouseup', end);
      })();
    </script>
  </body>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('/service-worker.js').catch(function(){});
      });
    }
  </script>
</html>

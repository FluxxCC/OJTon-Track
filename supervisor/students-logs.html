<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack ‚Äî Student Logs</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container centered">
      <div class="dashboard-main center-page">
        <h2 class="welcome">Student Logs</h2>
        <div class="attendance-card" style="margin-top:0.75rem">
          <div style="display:flex;align-items:center;gap:8px;justify-content:flex-start;font-size:18px;font-weight:700;margin-bottom:8px">
            <div>Students</div>
          </div>
          <div class="search-wrap" style="margin-bottom:10px;display:flex;gap:8px;align-items:center;position:relative">
            <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;opacity:0.75">üîç</span>
            <input id="searchInput" class="input" type="text" placeholder="Search student name or ID‚Ä¶" style="flex:1;padding-left:32px;border:1px solid #ccc" />
          </div>
          <div id="studentsBox" class="recent-scroll small" style="max-height:60vh;overflow-y:auto"><div class="skeleton-card"><div class="skeleton-line" style="width:60%"></div><div class="skeleton-line" style="width:40%;margin-top:8px"></div></div></div>
        </div>
      </div>
    </main>
    <nav class="student-nav">
      <div class="student-nav-inner">
        <a href="/supervisor/dashboard.html" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5l9-7 9 7"/><path d="M5 11v9h14v-9"/></svg>
        </a>
        <a href="/supervisor/attendance.html" aria-label="Attendance">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </a>
        <a href="/supervisor/students-logs.html" class="active" aria-label="Logs">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V5a2 2 0 012-2h10"/><path d="M20 7v12a2 2 0 01-2 2H6"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>
        </a>
        <a href="/supervisor/profile.html" aria-label="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </a>
      </div>
    </nav>
    <div id="studentDetailsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:16px;border-radius:12px;width:clamp(280px,80vw,480px);max-height:85vh;display:flex;flex-direction:column;gap:10px">
        <div style="font-weight:700;font-size:18px">Student Details</div>
        <div id="studentDetailsGrid" style="display:grid;grid-template-columns:auto 1fr;gap:8px 12px;align-items:center"></div>
        <button id="studentDetailsClose" class="role-button" style="padding:6px 12px">Close</button>
      </div>
    </div>
    <script>
      function authHeaders(json=false){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
      async function apiFetch(p, opts){
        const o = { credentials: 'include', mode: 'cors', redirect: 'follow', cache: 'no-store', ...(opts || {}) };
        try { return await fetch(p, o); } catch (e) {
          try {
            const url = new URL(p, window.location.origin);
            url.port = '3000';
            return await fetch(url.toString(), o);
          } catch (e2) { throw e; }
        }
      }
      async function ensureAuth() { const r = await apiFetch('/api/me', { headers: authHeaders() }); if (!r.ok) { window.location.replace('/index.html'); throw new Error('auth'); } return r.json(); }
      function fmtWhen(ts) { return new Date(ts).toLocaleString('en-US', { month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', second: '2-digit' }); }
      document.addEventListener('DOMContentLoaded', async function() {
        try { await ensureAuth(); } catch { return; }
        const box = document.getElementById('studentsBox');
        const search = document.getElementById('searchInput');
        box.innerHTML = '<div>Loading‚Ä¶</div>';
        try {
          const r = await apiFetch('/api/supervisor/students', { headers: authHeaders() });
          const j = await r.json().catch(()=>({}));
          let students = r.ok && j.ok ? (Array.isArray(j.data) ? j.data : []) : [];
          students.sort((a,b)=>String(a.name||a.idNumber||'').localeCompare(String(b.name||b.idNumber||'')));
          function render(){
            const q = String(search.value||'').trim().toLowerCase();
            const filtered = students.filter(s=>String(s.name||s.idNumber||'').toLowerCase().includes(q));
            if (!filtered.length) { box.innerHTML = '<div class="empty">No students found</div>'; return; }
            box.innerHTML = '';
            filtered.forEach(s => {
              const id = s.idNumber || s.idnumber || '';
              if (!id) return;
              const name = s.name || id;
              const wrap = document.createElement('div');
              wrap.className = 'list-card';
              wrap.style.padding = '12px';
              wrap.style.borderRadius = '16px';
              wrap.style.boxShadow = '0 4px 10px rgba(0,0,0,0.1)';
              const rowTop = document.createElement('div');
              rowTop.style.display = 'grid';
              rowTop.style.gridTemplateColumns = 'auto 1fr';
              rowTop.style.alignItems = 'center';
              rowTop.style.gap = '10px';
              const avatar = document.createElement('div');
              avatar.textContent = 'üßë‚Äçüéì';
              avatar.style.fontSize = '24px';
              const text = document.createElement('div');
              const title = document.createElement('div');
              title.className = 'title';
              title.textContent = name;
              const meta = document.createElement('div');
              meta.className = 'meta';
              meta.textContent = `${id}`;
              text.appendChild(title);
              text.appendChild(meta);
              rowTop.appendChild(avatar);
              rowTop.appendChild(text);
              const buttons = document.createElement('div');
              buttons.className = 'actions';
              buttons.style.display = 'grid';
              buttons.style.gridTemplateColumns = 'repeat(2,auto)';
              buttons.style.gap = '8px';
              buttons.style.justifyContent = 'center';
              buttons.style.justifyItems = 'center';
              const a1 = document.createElement('a');
              a1.className = 'role-button neutral';
              a1.href = '/supervisor/student-attendance.html?id=' + encodeURIComponent(id);
              a1.textContent = 'Logs';
              a1.style.padding = '6px 10px';
              a1.style.fontSize = '12px';
              a1.style.borderRadius = '999px';
              const b2 = document.createElement('button');
              b2.className = 'role-button neutral';
              b2.textContent = 'Details';
              b2.style.padding = '6px 10px';
              b2.style.fontSize = '12px';
              b2.style.borderRadius = '999px';
              b2.addEventListener('click', function(){ openDetails(id); });
              const ev = document.createElement('button');
              ev.className = 'role-button';
              ev.style.padding = '6px 10px';
              ev.style.fontSize = '12px';
              ev.style.borderRadius = '999px';
              ev.style.gridColumn = '1 / -1';
              ev.style.justifySelf = 'center';
              ev.style.marginTop = '6px';
              ev.textContent = 'Checking‚Ä¶';
              (async function(){
                try {
                  const sR = await apiFetch('/api/evaluations/'+encodeURIComponent(id)+'/summary', { headers: authHeaders(), cache: 'no-store' });
                  const sJ = await sR.json().catch(()=>({}));
                  const hasEval = !!(sR.ok && sJ.ok && Array.isArray(sJ.data?.summary) && (sJ.data.summary.length>0));
                  if (hasEval) { ev.textContent = 'Evaluation Completed'; ev.style.background = '#111827'; ev.style.color = '#fff'; ev.addEventListener('click', function(){ openEvalCompleted(name, id); }); return; }
                  const r = await apiFetch('/api/evaluation/status/'+encodeURIComponent(id), { headers: authHeaders(), cache: 'no-store' });
                  const j = await r.json().catch(()=>({}));
                  const enabled = !!(r.ok && j.enabled);
                  if (enabled) { ev.textContent = 'Evaluate Student'; ev.style.background = '#22c55e'; ev.style.color = '#fff'; ev.addEventListener('click', function(){ window.location.href = '/supervisor/student-evaluation.html?id=' + encodeURIComponent(id); }); }
                  else { ev.textContent = 'Evaluation Disabled'; ev.style.background = '#ef4444'; ev.style.color = '#fff'; ev.addEventListener('click', function(){ openEvalNotEnabled(name, id); }); }
                } catch { ev.textContent = 'Evaluation Disabled'; ev.style.background = '#ef4444'; ev.style.color = '#fff'; ev.addEventListener('click', function(){ openEvalNotEnabled(name, id); }); }
              })();
              buttons.appendChild(a1);
              buttons.appendChild(b2);
              buttons.appendChild(ev);
              wrap.appendChild(rowTop);
              wrap.appendChild(buttons);
              box.appendChild(wrap);
            });
          }
          render();
          window.addEventListener('storage', function(e){ try { if (e && e.key && /^eval:(update|completed):/.test(e.key)) render(); } catch {} });
          search.addEventListener('input', render);
        } catch { box.innerHTML = '<div class="empty">Error loading students</div>'; }
      });
    </script>
    <script>
      function addRowTo(grid,label,value){ const l=document.createElement('div'); l.className='stat-label'; l.textContent=label+':'; const v=document.createElement('div'); v.textContent=String(value||'‚Äî'); grid.appendChild(l); grid.appendChild(v); }
      async function openDetails(id){ const m=document.getElementById('studentDetailsModal'); const g=document.getElementById('studentDetailsGrid'); if(!m||!g) return; g.innerHTML=''; try{ const r=await apiFetch('/api/students',{ headers: authHeaders() }); const j=await r.json(); const rows=r.ok&&j.ok&&Array.isArray(j.data)?j.data:[]; const s=rows.find(x=>String(x.id_number||x.idNumber||'')===String(id)); const name=(s&&s.name)||id; const course=(s&& (s.course || s.course_id)) || ''; const section=(s&&s.section)||''; addRowTo(g,'Name',name); addRowTo(g,'ID Number',id); addRowTo(g,'Course',course||'‚Äî'); addRowTo(g,'Section',section||'‚Äî'); } catch { addRowTo(g,'ID Number',id); } m.style.display='flex'; }
      (function(){ const m=document.getElementById('studentDetailsModal'); const c=document.getElementById('studentDetailsClose'); if(m&&c){ m.addEventListener('click',function(e){ if(e.target===m) m.style.display='none'; }); c.addEventListener('click',function(){ m.style.display='none'; }); } })();
      function openEvalNotEnabled(name, id){
        const existing = document.getElementById('evalNotEnabledModal'); if (existing) existing.remove();
        const overlay = document.createElement('div'); overlay.id='evalNotEnabledModal'; overlay.className='open';
        const box = document.createElement('div');
        box.style.background = '#fff'; box.style.padding = '16px'; box.style.borderRadius = '12px'; box.style.width = 'clamp(280px,80vw,480px)'; box.style.maxHeight = '85vh'; box.style.display = 'flex'; box.style.flexDirection = 'column'; box.style.gap = '10px'; box.style.alignItems='center';
        const header = document.createElement('div'); header.style.fontWeight='800'; header.style.fontSize='1.05rem'; header.style.textAlign='center'; header.textContent='Instructor has not enabled evaluation';
        const actions = document.createElement('div'); actions.style.display='grid'; actions.style.gridTemplateColumns='1fr'; actions.style.gap='8px'; actions.style.justifyItems='center';
        const close = document.createElement('button'); close.className='role-button'; close.textContent='Close';
        close.addEventListener('click', function(){ overlay.remove(); });
        actions.appendChild(close);
        overlay.addEventListener('click', function(e){ if (e.target===overlay) overlay.remove(); });
        box.addEventListener('click', function(e){ e.stopPropagation(); });
        box.appendChild(header); box.appendChild(actions);
        document.body.appendChild(overlay); overlay.appendChild(box);
      }
      function openEvalCompleted(name, id){
        const existing = document.getElementById('evalCompletedModal'); if (existing) existing.remove();
        const overlay = document.createElement('div'); overlay.id='evalCompletedModal'; overlay.className='open';
        const box = document.createElement('div');
        box.style.background = '#fff'; box.style.padding = '16px'; box.style.borderRadius = '12px'; box.style.width = 'clamp(280px,80vw,480px)'; box.style.maxHeight = '85vh'; box.style.display = 'flex'; box.style.flexDirection = 'column'; box.style.gap = '10px'; box.style.alignItems='center';
        const header = document.createElement('div'); header.style.fontWeight='800'; header.style.fontSize='1.05rem'; header.style.textAlign='center'; header.textContent='Evaluation is completed';
        const actions = document.createElement('div'); actions.style.display='grid'; actions.style.gridTemplateColumns='1fr'; actions.style.gap='8px'; actions.style.justifyItems='center';
        const close = document.createElement('button'); close.className='role-button'; close.textContent='Close';
        close.addEventListener('click', function(){ overlay.remove(); });
        actions.appendChild(close);
        overlay.addEventListener('click', function(e){ if (e.target===overlay) overlay.remove(); });
        box.addEventListener('click', function(e){ e.stopPropagation(); });
        box.appendChild(header); box.appendChild(actions);
        document.body.appendChild(overlay); overlay.appendChild(box);
      }
    </script>
    <script>
      (function(){
        const nav = document.querySelector('.student-nav'); if (!nav) return; nav.classList.add('slideable');
        let startY=null, lastY=null, moved=0;
        function start(e){ const t=e.touches?e.touches[0]:e; startY=t.clientY; lastY=startY; moved=0; }
        function move(e){ const t=e.touches?e.touches[0]:e; lastY=t.clientY; moved=lastY-startY; }
        function end(){ if (moved>30) { document.body.classList.add('nav-hidden'); } else if (moved<-30) { document.body.classList.remove('nav-hidden'); } else { document.body.classList.toggle('nav-hidden'); } startY=null; lastY=null; moved=0; }
        nav.addEventListener('touchstart', start, { passive:true });
        nav.addEventListener('touchmove', move, { passive:true });
        nav.addEventListener('touchend', end);
        nav.addEventListener('mousedown', start);
        nav.addEventListener('mousemove', function(e){ if (startY!==null) move(e); });
        nav.addEventListener('mouseup', end);
      })();
    </script>
  </body>
</html>

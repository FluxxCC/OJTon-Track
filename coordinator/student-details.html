<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack â€“ Student Details</title>
    <link rel="stylesheet" href="/styles.css" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  </head>
  <body>
    <main id="root"><div class="container" style="width:min(92vw,560px);margin:2rem auto;padding:1rem;border:2px solid #d1d5db;border-radius:10px;background:#fff;text-align:center;font-weight:700;">Loadingâ€¦</div></main>
    <script>
      function authHeaders(json=false){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
      async function getMe() { const r = await fetch('/api/me', { headers: authHeaders() }); const j = await r.json().catch(() => ({})); if (!r.ok) { window.location.replace('/index.html'); throw new Error('auth'); } return j; }
      function Page(){
        const [course, setCourse] = React.useState('');
        const [id, setId] = React.useState('');
        const [item, setItem] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState('');
        const [hasCourseParam, setHasCourseParam] = React.useState(false);
        const [courseParam, setCourseParam] = React.useState('');
        const [editing, setEditing] = React.useState(null);
        const [toDelete, setToDelete] = React.useState(null);

        React.useEffect(()=>{ (async()=>{ try{ const j = await getMe(); setCourse(String(j.data?.course||'')); }catch{} })(); const u = new URL(window.location.href); const pid = String(u.searchParams.get('id')||'').trim(); const pc = String(u.searchParams.get('course')||'').trim(); if (!pid) { window.location.replace('/coordinator/students.html'); return; } setId(pid); if (pc) { setCourseParam(pc); setHasCourseParam(true); } })

        React.useEffect(()=>{ if(!id) return; setLoading(true); fetch('/api/students', { headers: authHeaders() }).then(async r=>{ const j = await r.json().catch(()=>({})); if (r.ok && j && j.ok && Array.isArray(j.data)) { const rows = j.data; const found = rows.find(x => String(x.idNumber||x.idnumber||'') === String(id)); if (found) { setItem(found); setError(''); } else { setItem(null); setError('Student not found'); } } else { setError((j && j.error)||'Failed to load'); } }).catch(()=>setError('Failed to load')).finally(()=>setLoading(false)); },[id]);

        async function updateStudent(payload){ const resp = await fetch('/api/students/' + id, { method:'PUT', headers: authHeaders(true), body: JSON.stringify(payload) }); const json = await resp.json(); if (resp.ok && json.ok) { const name = payload.firstName || payload.lastName ? [payload.firstName||'', payload.middleName||'', payload.lastName||''].filter(Boolean).join(' ') : (item.name||''); setItem({ ...item, ...payload, name }); setEditing(null); } else alert(json.error || 'Failed'); }
        async function deleteStudent(){ const resp = await fetch('/api/students/' + id, { method:'DELETE', headers: authHeaders() }); const json = await resp.json(); if (resp.ok && json.ok) { const back = hasCourseParam ? ('/coordinator/students.html?course=' + encodeURIComponent(courseParam)) : '/coordinator/students.html'; window.location.replace(back); } else alert(json.error || 'Failed'); }

        function ModalEdit(){ if(!editing) return null; React.useEffect(()=>{ function onKey(e){ if(e.key==='Escape') setEditing(null); } window.addEventListener('keydown', onKey); return ()=>window.removeEventListener('keydown', onKey); },[editing]); function submit(e){ e.preventDefault(); const f = e.currentTarget; const payload = { firstName: (f.firstName?.value||'').trim(), middleName: (f.middleName?.value||'').trim(), lastName: (f.lastName?.value||'').trim(), section: (f.section?.value||'').trim() || null, supervisorId: (f.supervisorId?.value||'').trim() || null }; if (!payload.firstName || !payload.lastName) { alert('First and Last name are required'); return; } updateStudent(payload); }
          const overlayStyle = { position:'fixed', inset:0, background:'rgba(2,6,23,0.5)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:50, padding:0 };
          const modalStyle = { width:'min(92vw, 560px)', background:'#ffffff', borderRadius:12, boxShadow:'0 10px 30px rgba(0,0,0,0.25)', padding:'1rem', boxSizing:'border-box', margin:0 };
          return React.createElement('div',{ key:'overlay', style: overlayStyle, onClick: ()=>setEditing(null) },[
            React.createElement('div',{ key:'modal', style:{ ...modalStyle, textAlign:'center', position:'relative', overflow:'hidden' }, onClick:e=>e.stopPropagation() },[
              React.createElement('div',{ key:'head', style:{ display:'flex', alignItems:'center', justifyContent:'center', marginBottom:'0.5rem' } },[ React.createElement('div',{ key:'title', style:{ fontWeight:700 } }, 'Edit Student (' + id + ')') ]),
              React.createElement('div',{ key:'content', style:{ width:'100%', margin:'0 auto' } },[
                React.createElement('form',{ key:'form', className:'form', onSubmit: submit, style:{ display:'grid', gap:'0.75rem', justifyItems:'center', textAlign:'center', marginTop:0, width:'100%' } },[
                  React.createElement('input',{ key:'firstName', className:'input', name:'firstName', defaultValue:item && item.firstName || '', placeholder:'First Name', required:true, style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  React.createElement('input',{ key:'middleName', className:'input', name:'middleName', defaultValue:item && item.middleName || '', placeholder:'Middle Name', style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  React.createElement('input',{ key:'lastName', className:'input', name:'lastName', defaultValue:item && item.lastName || '', placeholder:'Last Name', required:true, style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  React.createElement('select',{ key:'section', className:'input', name:'section', defaultValue:item && item.section || '', style:{ width:'94%', margin:'0 auto', textAlign:'center', textAlignLast:'center', MozTextAlignLast:'center' } },[
                    React.createElement('option',{ key:'phs', value:'' },'Assign Section'),
                    React.createElement('option',{ key:'4A', value:'4A' },'4A'), React.createElement('option',{ key:'4B', value:'4B' },'4B'), React.createElement('option',{ key:'4C', value:'4C' },'4C'), React.createElement('option',{ key:'4D', value:'4D' },'4D')
                  ]),
                  React.createElement('input',{ key:'supervisorId', className:'input', name:'supervisorId', defaultValue:item && (item.supervisorId || item.supervisorid) || '', placeholder:'Supervisor ID (optional)', style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  
                  React.createElement('div',{ key:'actions', className:'buttons', style:{ display:'grid', gridTemplateColumns:'1fr', gap:'0.5rem', justifyItems:'center', width:'100%', margin:0 } },[
                    React.createElement('button',{ key:'save', className:'role-button', type:'submit', style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Save Changes'),
                    React.createElement('button',{ key:'cancel', className:'role-button', type:'button', onClick: ()=>setEditing(null), style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Cancel')
                  ])
                ])
              ])
            ])
          ]);
        }

        function DeleteConfirm(){ if(!toDelete) return null; React.useEffect(()=>{ function onKey(e){ if(e.key==='Escape') setToDelete(null); } window.addEventListener('keydown', onKey); return ()=>window.removeEventListener('keydown', onKey); },[toDelete]); const overlayStyle = { position:'fixed', inset:0, background:'rgba(2,6,23,0.5)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:50, padding:0 }; const modalStyle = { width:'min(92vw, 560px)', background:'var(--surface-alpha)', borderRadius:12, boxShadow:'0 10px 30px rgba(0,0,0,0.25)', padding:'1rem', boxSizing:'border-box', margin:0 }; function confirmDelete(){ deleteStudent().then(()=>setToDelete(null)); } function close(){ setToDelete(null); } return React.createElement('div',{ key:'overlay', style: overlayStyle, onClick: close },[ React.createElement('div',{ key:'modal', style:{ ...modalStyle, textAlign:'center', position:'relative' }, onClick:e=>e.stopPropagation() },[ React.createElement('div',{ key:'title', style:{ fontWeight:700, marginBottom:'0.5rem' } },'Are you sure you want to delete this user?'), React.createElement('div',{ key:'actions', className:'buttons', style:{ display:'grid', gridTemplateColumns:'1fr', gap:'0.5rem', justifyItems:'center', width:'100%' } },[ React.createElement('button',{ key:'yes', className:'role-button danger', type:'button', onClick: confirmDelete, style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Delete'), React.createElement('button',{ key:'no', className:'role-button', type:'button', onClick: close, style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Cancel') ]) ]) ]); }

        function Details(){ if (loading) return React.createElement('div',{ className:'container', style:{ width:'min(92vw, 560px)', margin:'0.5rem auto', padding:'0.75rem', border:'1px solid var(--border-alpha)', borderRadius:12, background:'var(--surface-alpha)', textAlign:'center' } }, 'Loadingâ€¦'); if (error) return React.createElement('div',{ className:'empty', style:{ width:'min(92vw,560px)', margin:'0.5rem auto' } }, error); if (!item) return React.createElement('div',{ className:'empty', style:{ width:'min(92vw,560px)', margin:'0.5rem auto' } }, 'No data'); const c0 = String(item.course||'').trim(); const s0 = String(item.section||'').trim(); const inferred = (!c0 && s0) ? String(s0).split(' ')[0] : ''; const cc = c0 || inferred || ''; const sid = String(item.supervisorId || item.supervisorid || '').trim(); const supName = String(item.supervisorName||'').trim(); const supLabel = supName || sid || 'â€”'; const [supCompany, setSupCompany] = React.useState(''); const [supLocation, setSupLocation] = React.useState(''); React.useEffect(()=>{ let alive = true; async function load(){ try { if (!sid) { setSupCompany(''); setSupLocation(''); return; } const r = await fetch('/api/supervisors', { headers: authHeaders(), cache:'no-store' }); const j = await r.json().catch(()=>({})); const rows = r.ok && j.ok && Array.isArray(j.data) ? j.data : []; const found = rows.find(x => String(x.idNumber||x.idnumber||'') === String(sid)); const comp = String(found && (found.company||'') || '').trim(); const loc = String(found && (found.location||'') || '').trim(); if (alive) { setSupCompany(comp); setSupLocation(loc); } } catch { if (alive) { setSupCompany(''); setSupLocation(''); } } } load(); return ()=>{ alive=false; }; }, [sid]); return React.createElement('div',{ className:'attendance-card', style:{ width:'min(92vw,560px)', margin:'0.5rem auto' } },[
          React.createElement('div',{ key:'name', className:'stat-label', style:{ marginTop:'6px' } }, [
            React.createElement('span',{ key:'l', style:{ fontWeight:700 } }, 'Name: '),
            React.createElement('span',{ key:'v' }, (item.name||'(No name)'))
          ]),
          React.createElement('div',{ key:'idnum', className:'stat-label', style:{ marginTop:'6px' } }, [
            React.createElement('span',{ key:'l', style:{ fontWeight:700 } }, 'Student ID: '),
            React.createElement('span',{ key:'v' }, id)
          ]),
          React.createElement('div',{ key:'course', className:'stat-label', style:{ marginTop:'6px' } }, [
            React.createElement('span',{ key:'l', style:{ fontWeight:700 } }, 'Course: '),
            React.createElement('span',{ key:'v' }, (cc || 'â€”'))
          ]),
          React.createElement('div',{ key:'section', className:'stat-label', style:{ marginTop:'6px' } }, [
            React.createElement('span',{ key:'l', style:{ fontWeight:700 } }, 'Section: '),
            React.createElement('span',{ key:'v' }, (item.section || 'â€”'))
          ]),
          React.createElement('div',{ key:'supervisor', className:'stat-label', style:{ marginTop:'6px' } }, [
            React.createElement('span',{ key:'l', style:{ fontWeight:700 } }, 'Supervisor: '),
            React.createElement('span',{ key:'v' }, supLabel)
          ]),
          React.createElement('div',{ key:'company', className:'stat-label', style:{ marginTop:'6px' } }, [
            React.createElement('span',{ key:'l', style:{ fontWeight:700 } }, 'Designated Area: '),
            React.createElement('span',{ key:'v' }, (supCompany || 'â€”'))
          ]),
          React.createElement('div',{ key:'location', className:'stat-label', style:{ marginTop:'6px' } }, [
            React.createElement('span',{ key:'l', style:{ fontWeight:700 } }, 'Location: '),
            React.createElement('span',{ key:'v' }, (supLocation || 'â€”'))
          ]),
          React.createElement('div',{ key:'actions', className:'buttons', style:{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.5rem', width:'100%', marginTop:'0.75rem' } },[
            React.createElement('button',{ key:'edit', className:'role-button neutral', type:'button', onClick: ()=>setEditing(item), style:{ display:'inline-flex', alignItems:'center', justifyContent:'center', gap:'8px', borderColor:'#93c5fd', background:'#eef2ff' } }, [
              React.createElement('span',{ key:'icon' }, 'âœï¸'),
              React.createElement('span',{ key:'text' }, 'Edit')
            ]),
            React.createElement('button',{ key:'del', className:'role-button danger', type:'button', onClick: ()=>setToDelete(id), style:{ display:'inline-flex', alignItems:'center', justifyContent:'center', gap:'8px', background:'#fee2e2', borderColor:'#fca5a5' } }, [
              React.createElement('span',{ key:'icon' }, 'ðŸ—‘'),
              React.createElement('span',{ key:'text' }, 'Delete')
            ])
          ])
        ]); }

        const backHref = hasCourseParam ? ('/coordinator/students.html?course=' + encodeURIComponent(courseParam)) : '/coordinator/students.html';
        return React.createElement('main',{ className:'container' },[
          React.createElement('h1',{ key:'t', className:'title' },'OJTonTrack'),
          React.createElement('p',{ key:'sub', className:'subtitle', style:{ fontSize:'1rem', color:'#4b5563' } }, 'Coordinator â†’ ' + (hasCourseParam ? (courseParam || 'UNKNOWN') : (course || 'UNKNOWN')) + ' â†’ Student Details'),
          React.createElement(Details,{ key:'details' }),
          React.createElement(ModalEdit,{ key:'editModal' }),
          React.createElement(DeleteConfirm,{ key:'deleteConfirm' }),
          React.createElement('div',{ key:'backwrap', className:'buttons', style:{ width:'min(92vw,560px)', margin:'0.5rem auto 0', display:'grid', gridTemplateColumns:'1fr', gap:'0.5rem', justifyItems:'stretch' } },[
            React.createElement('a',{ key:'back', className:'role-button', href: backHref, style:{ width:'100%' } },'Back')
          ])
        ]);
      }
      (function(){ const el = document.getElementById('root'); if (!window.React || !window.ReactDOM) { if (el) el.innerHTML = '<div style="width:min(92vw,560px);margin:2rem auto;padding:1rem;border:2px solid #d1d5db;border-radius:10px;background:#fff;text-align:center;font-weight:700;">Failed to load UI. Check internet connection for CDN scripts.</div>'; return; } try { const root = ReactDOM.createRoot(el); root.render(React.createElement(Page)); } catch (e) { if (el) el.innerHTML = '<div style="width:min(92vw,560px);margin:2rem auto;padding:1rem;border:2px solid #d1d5db;border-radius:10px;background:#fff;text-align:center;font-weight:700;">Page error: ' + String(e && e.message || 'Unknown') + '</div>'; } })();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack â€“ Supervisor Details</title>
    <link rel="stylesheet" href="/styles.css" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  </head>
  <body>
    <main id="root"><div class="container" style="width:min(92vw,560px);margin:2rem auto;padding:1rem;border:2px solid #d1d5db;border-radius:10px;background:#fff;text-align:center;font-weight:700;">Loadingâ€¦</div></main>
    <script>
      function authHeaders(json=false){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
      async function getMe() { const r = await fetch('/api/me', { headers: authHeaders() }); const j = await r.json().catch(() => ({})); if (!r.ok) { window.location.replace('/index.html'); throw new Error('auth'); } return j; }
      function Page(){
        const [course, setCourse] = React.useState('');
        const [id, setId] = React.useState('');
        const [item, setItem] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState('');
        const [hasCourseParam, setHasCourseParam] = React.useState(false);
        const [courseParam, setCourseParam] = React.useState('');
        const [editing, setEditing] = React.useState(null);
        const [toDelete, setToDelete] = React.useState(null);
        const [students, setStudents] = React.useState([]);
        const [sLoading, setSLoading] = React.useState(true);
        const [sProgress, setSProgress] = React.useState(0);

        React.useEffect(()=>{ (async()=>{ try{ const j = await getMe(); setCourse(String(j.data?.course||'')); }catch{} })(); const u = new URL(window.location.href); const pid = String(u.searchParams.get('id')||'').trim(); const pc = String(u.searchParams.get('course')||'').trim(); if (!pid) { window.location.replace('/coordinator/supervisors.html'); return; } setId(pid); if (pc) { setCourseParam(pc); setHasCourseParam(true); } })
        
        React.useEffect(()=>{ if(!id) return; setLoading(true); fetch('/api/supervisors', { headers: authHeaders() }).then(async r=>{ const j = await r.json().catch(()=>({})); if (r.ok && j && j.ok && Array.isArray(j.data)) { const rows = j.data; const found = rows.find(x => String(x.idNumber||'') === String(id)); if (found) { setItem(found); setError(''); } else { setItem(null); setError('Supervisor not found'); } } else { setError((j && j.error)||'Failed to load'); } }).catch(()=>setError('Failed to load')).finally(()=>setLoading(false)); },[id]);

        React.useEffect(()=>{
          if(!id) return;
          let active = true;
          (async()=>{
            setSLoading(true);
            setSProgress(5);
            try {
              const r = await fetch('/api/students', { headers: authHeaders() });
              if (!active) return;
              setSProgress(30);
              const j = await r.json().catch(()=>({}));
              if (!active) return;
              setSProgress(60);
              if (r.ok && j && j.ok && Array.isArray(j.data)) {
                const rows = j.data;
                const list = rows.filter(s => {
                  const sid = String(s.supervisorid || s.supervisorId || '');
                  const byId = sid === String(id);
                  let byName = false;
                  if (!byId && item) {
                    const sn = String(s.supervisorName || '').trim();
                    const iname = String(item.name || '').trim();
                    byName = !!sn && !!iname && sn === iname;
                  }
                  return byId || byName;
                });
                setStudents(list);
                setSProgress(90);
              } else {
                setStudents([]);
                setSProgress(90);
              }
            } catch {
              if (!active) return;
              setStudents([]);
              setSProgress(90);
            }
            await new Promise(resolve => requestAnimationFrame(resolve));
            if (!active) return;
            setSProgress(100);
            setSLoading(false);
          })();
          return () => { active = false; };
        },[id, item]);

        async function updateSupervisor(payload){ const resp = await fetch('/api/supervisors/' + id, { method:'PUT', headers: authHeaders(true), body: JSON.stringify(payload) }); const json = await resp.json(); if (resp.ok && json.ok) { setItem({ ...item, ...payload, name: payload.name || item.name }); setEditing(null); } else if ((json && json.error) === 'Forbidden') { alert('Forbidden: coordinator auth required'); } else alert(json.error || 'Failed'); }
        async function deleteSupervisor(){ const resp = await fetch('/api/supervisors/' + id, { method:'DELETE', headers: authHeaders() }); const json = await resp.json(); if (resp.ok && json.ok) { const back = hasCourseParam ? ('/coordinator/supervisors.html?course=' + encodeURIComponent(courseParam)) : '/coordinator/supervisors.html'; window.location.replace(back); } else if ((json && json.error) === 'Forbidden') { alert('Forbidden: coordinator auth required'); } else alert(json.error || 'Failed'); }

        function ModalEdit(){ if(!editing) return null; React.useEffect(()=>{ function onKey(e){ if(e.key==='Escape') setEditing(null); } window.addEventListener('keydown', onKey); return ()=>window.removeEventListener('keydown', onKey); },[editing]); function submit(e){ e.preventDefault(); const f = e.currentTarget; const firstName = (f.firstName?.value||'').trim(); const middleName = (f.middleName?.value||'').trim(); const lastName = (f.lastName?.value||'').trim(); if (!firstName || !lastName) { alert('First and Last name are required'); return; } const fullName = [firstName, middleName, lastName].filter(Boolean).join(' '); const payload = { name: fullName, company: (f.company?.value||'').trim()||null, location: (f.location?.value||'').trim()||null, section: (f.section?.value||'').trim()||null }; updateSupervisor(payload); }
          const overlayStyle = { position:'fixed', inset:0, background:'rgba(2,6,23,0.5)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:50, padding:0 };
          const modalStyle = { width:'min(92vw, 560px)', background:'#ffffff', borderRadius:12, boxShadow:'0 10px 30px rgba(0,0,0,0.25)', padding:'1rem', boxSizing:'border-box', margin:0 };
          return React.createElement('div',{ key:'overlay', style: overlayStyle, onClick: ()=>setEditing(null) },[
            React.createElement('div',{ key:'modal', style:{ ...modalStyle, textAlign:'center', position:'relative', overflow:'hidden' }, onClick:e=>e.stopPropagation() },[
              React.createElement('div',{ key:'head', style:{ display:'flex', alignItems:'center', justifyContent:'center', marginBottom:'0.5rem' } },[ React.createElement('div',{ key:'title', style:{ fontWeight:700 } }, 'Edit Supervisor (' + id + ')') ]),
              React.createElement('div',{ key:'content', style:{ width:'100%', margin:'0 auto' } },[
                (function(){ const nm = String(item && item.name || '').trim(); const parts = nm ? nm.split(/\s+/) : []; const dFirst = parts[0]||''; const dLast = parts.length>1 ? parts[parts.length-1] : ''; const dMiddle = parts.slice(1,-1).join(' '); return React.createElement('form',{ key:'form', className:'form', onSubmit: submit, style:{ display:'grid', gap:'0.75rem', justifyItems:'center', textAlign:'center', marginTop:0, width:'100%' } },[
                  React.createElement('input',{ key:'firstName', className:'input', name:'firstName', defaultValue:dFirst, placeholder:'First Name', required:true, style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  React.createElement('input',{ key:'middleName', className:'input', name:'middleName', defaultValue:dMiddle, placeholder:'Middle Name (optional)', style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  React.createElement('input',{ key:'lastName', className:'input', name:'lastName', defaultValue:dLast, placeholder:'Last Name', required:true, style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  React.createElement('input',{ key:'company', className:'input', name:'company', defaultValue:item && item.company || '', placeholder:'Company', style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  React.createElement('input',{ key:'location', className:'input', name:'location', defaultValue:item && item.location || '', placeholder:'Location', style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  React.createElement('input',{ key:'section', className:'input', name:'section', defaultValue:item && item.section || '', placeholder:'Section (optional)', style:{ width:'94%', margin:'0 auto', textAlign:'center' } }),
                  
                  React.createElement('div',{ key:'actions', className:'buttons', style:{ display:'grid', gridTemplateColumns:'1fr', gap:'0.5rem', justifyItems:'center', width:'100%', margin:0 } },[
                    React.createElement('button',{ key:'save', className:'role-button', type:'submit', style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Save Changes'),
                    React.createElement('button',{ key:'cancel', className:'role-button', type:'button', onClick: ()=>setEditing(null), style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Cancel')
                  ])
                ]) })()
              ])
            ])
          ]);
        }

        function DeleteConfirm(){ if(!toDelete) return null; React.useEffect(()=>{ function onKey(e){ if(e.key==='Escape') setToDelete(null); } window.addEventListener('keydown', onKey); return ()=>window.removeEventListener('keydown', onKey); },[toDelete]); const overlayStyle = { position:'fixed', inset:0, background:'rgba(2,6,23,0.5)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:50, padding:0 }; const modalStyle = { width:'min(92vw, 560px)', background:'var(--surface-alpha)', borderRadius:12, boxShadow:'0 10px 30px rgba(0,0,0,0.25)', padding:'1rem', boxSizing:'border-box', margin:0 }; function confirmDelete(){ deleteSupervisor().then(()=>setToDelete(null)); } function close(){ setToDelete(null); } return React.createElement('div',{ key:'overlay', style: overlayStyle, onClick: close },[ React.createElement('div',{ key:'modal', style:{ ...modalStyle, textAlign:'center', position:'relative' }, onClick:e=>e.stopPropagation() },[ React.createElement('div',{ key:'title', style:{ fontWeight:700, marginBottom:'0.5rem' } },'Are you sure you want to delete this user?'), React.createElement('div',{ key:'actions', className:'buttons', style:{ display:'grid', gridTemplateColumns:'1fr', gap:'0.5rem', justifyItems:'center', width:'100%' } },[ React.createElement('button',{ key:'yes', className:'role-button danger', type:'button', onClick: confirmDelete, style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Delete'), React.createElement('button',{ key:'no', className:'role-button', type:'button', onClick: close, style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Cancel') ]) ]) ]); }

        function Details(){ if (loading) return React.createElement('div',{ className:'container', style:{ width:'min(92vw, 560px)', margin:'0.5rem auto', padding:'0.75rem', border:'1px solid var(--border-alpha)', borderRadius:12, background:'var(--surface-alpha)', textAlign:'center' } }, 'Loadingâ€¦'); if (error) return React.createElement('div',{ className:'empty', style:{ width:'min(92vw,560px)', margin:'0.5rem auto' } }, error); if (!item) return React.createElement('div',{ className:'empty', style:{ width:'min(92vw,560px)', margin:'0.5rem auto' } }, 'No data'); const c0 = String(item.course||'').trim(); const s0 = String(item.section||'').trim(); const inferred = (!c0 && s0) ? String(s0).split(' ')[0] : ''; const cc = c0 || inferred || ''; return React.createElement('div',{ className:'attendance-card', style:{ width:'min(92vw,560px)', margin:'0.5rem auto' } },[
          React.createElement('div',{ key:'name', className:'stat-label' }, (item.name||'(No name)') + ' (' + id + ')'),
          React.createElement('div',{ key:'company', className:'stat-label' }, 'Company: ' + (item.company || 'â€”')),
          React.createElement('div',{ key:'location', className:'stat-label' }, 'Location: ' + (item.location || 'â€”')),
          React.createElement('div',{ key:'course', className:'stat-label' }, 'Course: ' + (cc || 'â€”')),
          React.createElement('div',{ key:'section', className:'stat-label' }, 'Section: ' + (item.section || 'â€”')),
          React.createElement('div',{ key:'actions', className:'buttons', style:{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.5rem', width:'100%', marginTop:'0.75rem' } },[
            React.createElement('button',{ key:'edit', className:'role-button neutral', type:'button', onClick: ()=>setEditing(item) }, 'âœï¸ Edit'),
            React.createElement('button',{ key:'del', className:'role-button danger', type:'button', onClick: ()=>setToDelete(id) }, 'ðŸ—‘ Delete')
          ])
        ]); }

        const backHref = hasCourseParam ? ('/coordinator/supervisors.html?course=' + encodeURIComponent(courseParam)) : '/coordinator/supervisors.html';
        return React.createElement('main',{ className:'container' },[
          React.createElement('h1',{ key:'t', className:'title' },'OJTonTrack'),
          React.createElement('p',{ key:'sub', className:'subtitle', style:{ fontSize:'1rem', color:'#4b5563' } }, 'Coordinator â†’ ' + (hasCourseParam ? (courseParam || 'UNKNOWN') : (course || 'UNKNOWN')) + ' â†’ Supervisor Details'),
          React.createElement(Details,{ key:'details' }),
          React.createElement('div',{ key:'studentsTitle', className:'recent-label', style:{ width:'min(92vw,560px)', margin:'0.5rem auto', textAlign:'center' } }, 'Handled Students (' + (students.length||0) + ')'),
          React.createElement('div',{ key:'studentsBox', style:{ width:'min(92vw, 560px)', maxHeight:'min(42.1vh, 287px)', overflowY:'auto', overflowX:'hidden', scrollSnapType:'y mandatory', border:'1px solid var(--border-alpha)', borderRadius:12, background:'var(--surface-alpha)', padding:'0.75rem', margin:'0.5rem auto' } },[
            sLoading ? React.createElement('div',{ key:'pb', style:{ width:'100%', margin:'0 auto' } }, [
              React.createElement('div',{ key:'tag', style:{ textAlign:'center', fontWeight:600, marginBottom:6 } }, 'Loading ' + Math.round(sProgress) + '%'),
              React.createElement('div',{ key:'bar', style:{ width:'100%', height:10, background:'var(--border-alpha)', borderRadius:9999, overflow:'hidden' } }, [
                React.createElement('div',{ key:'fill', style:{ width: Math.max(4, Math.round(sProgress)) + '%', height:'100%', background:'#0ea5e9' } })
              ])
            ]) : (students.length ? students.map(s => React.createElement('div',{ key:String(s.idnumber||s.idNumber||Math.random()), className:'list-card', style:{ scrollSnapAlign:'start' } },[
              React.createElement('div',{ key:'title', className:'title' }, String(s.name||'').trim() ? (String(s.name||'').trim() + ' (' + String(s.idnumber||s.idNumber||'') + ')') : String(s.idnumber||s.idNumber||'')),
              React.createElement('div',{ key:'meta', className:'meta' }, 'Course ' + (String(s.course||'').trim() || 'â€”') + ' â€¢ Section ' + (String(s.section||'').trim() || 'â€”'))
            ])) : React.createElement('div',{ className:'empty' },'No students assigned'))
          ]),
          React.createElement(ModalEdit,{ key:'editModal' }),
          React.createElement(DeleteConfirm,{ key:'deleteConfirm' }),
          React.createElement('div',{ key:'backwrap', className:'buttons', style:{ width:'min(92vw,560px)', margin:'1rem auto 0', display:'grid', gridTemplateColumns:'1fr', gap:'0.5rem', justifyItems:'stretch' } },[
            React.createElement('a',{ key:'back', className:'role-button', href: backHref, style:{ width:'100%' } },'Back')
          ])
        ]);
      }
      (function(){ const el = document.getElementById('root'); if (!window.React || !window.ReactDOM) { if (el) el.innerHTML = '<div style="width:min(92vw,560px);margin:2rem auto;padding:1rem;border:2px solid #d1d5db;border-radius:10px;background:#fff;text-align:center;font-weight:700;">Failed to load UI. Check internet connection for CDN scripts.</div>'; return; } try { const root = ReactDOM.createRoot(el); root.render(React.createElement(Page)); } catch (e) { if (el) el.innerHTML = '<div style="width:min(92vw,560px);margin:2rem auto;padding:1rem;border:2px solid #d1d5db;border-radius:10px;background:#fff;text-align:center;font-weight:700;">Page error: ' + String(e && e.message || 'Unknown') + '</div>'; } })();
    </script>
  </body>
</html>
